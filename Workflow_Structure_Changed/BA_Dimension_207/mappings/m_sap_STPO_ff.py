# Databricks notebook source
# MAGIC %run "./udf_informatica"

# COMMAND ----------


from pyspark.sql.types import *

spark.sql("use DELTA_TRAINING")
spark.sql("set spark.sql.legacy.timeParserPolicy = LEGACY")

# COMMAND ----------
%run ./MappingUtility

# COMMAND ----------
mainWorkflowId = dbutils.widgets.get("mainWorkflowId")
mainWorkflowRunId = dbutils.widgets.get("mainWorkflowRunId")
parentName = dbutils.widgets.get("parentName")
preVariableAssignment = dbutils.widgets.get("preVariableAssignment")
postVariableAssignment = dbutils.widgets.get("postVariableAssignment")
truncTargetTableOptions = dbutils.widgets.get("truncTargetTableOptions")
variablesTableName = dbutils.widgets.get("variablesTableName")

# COMMAND ----------
#Truncate Target Tables
truncateTargetTables(truncTargetTableOptions)

# COMMAND ----------
#Pre presession variable updation
updateVariable(preVariableAssignment, variablesTableName, mainWorkflowId, parentName, "m_sap_STPO_ff")

# COMMAND ----------
fetchAndCreateVariables(parentName,"m_sap_STPO_ff", variablesTableName, mainWorkflowId)

# COMMAND ----------
# DBTITLE 1, Shortcut_to_STPO_0


query_0 = f"""SELECT
  MANDT AS MANDT,
  STLTY AS STLTY,
  STLNR AS STLNR,
  STLKN AS STLKN,
  STPOZ AS STPOZ,
  DATUV AS DATUV,
  TECHV AS TECHV,
  AENNR AS AENNR,
  LKENZ AS LKENZ,
  VGKNT AS VGKNT,
  VGPZL AS VGPZL,
  ANDAT AS ANDAT,
  ANNAM AS ANNAM,
  AEDAT AS AEDAT,
  AENAM AS AENAM,
  IDNRK AS IDNRK,
  PSWRK AS PSWRK,
  POSTP AS POSTP,
  POSNR AS POSNR,
  SORTF AS SORTF,
  MEINS AS MEINS,
  MENGE AS MENGE,
  FMENG AS FMENG,
  AUSCH AS AUSCH,
  AVOAU AS AVOAU,
  NETAU AS NETAU,
  SCHGT AS SCHGT,
  BEIKZ AS BEIKZ,
  ERSKZ AS ERSKZ,
  RVREL AS RVREL,
  SANFE AS SANFE,
  SANIN AS SANIN,
  SANKA AS SANKA,
  SANKO AS SANKO,
  SANVS AS SANVS,
  STKKZ AS STKKZ,
  REKRI AS REKRI,
  REKRS AS REKRS,
  CADPO AS CADPO,
  NFMAT AS NFMAT,
  NLFZT AS NLFZT,
  VERTI AS VERTI,
  ALPOS AS ALPOS,
  EWAHR AS EWAHR,
  EKGRP AS EKGRP,
  LIFZT AS LIFZT,
  LIFNR AS LIFNR,
  PREIS AS PREIS,
  PEINH AS PEINH,
  WAERS AS WAERS,
  SAKTO AS SAKTO,
  ROANZ AS ROANZ,
  ROMS1 AS ROMS1,
  ROMS2 AS ROMS2,
  ROMS3 AS ROMS3,
  ROMEI AS ROMEI,
  ROMEN AS ROMEN,
  RFORM AS RFORM,
  UPSKZ AS UPSKZ,
  VALKZ AS VALKZ,
  LTXSP AS LTXSP,
  POTX1 AS POTX1,
  POTX2 AS POTX2,
  OBJTY AS OBJTY,
  MATKL AS MATKL,
  WEBAZ AS WEBAZ,
  DOKAR AS DOKAR,
  DOKNR AS DOKNR,
  DOKVR AS DOKVR,
  DOKTL AS DOKTL,
  CSSTR AS CSSTR,
  CLASS AS CLASS,
  KLART AS KLART,
  POTPR AS POTPR,
  AWAKZ AS AWAKZ,
  INSKZ AS INSKZ,
  VCEKZ AS VCEKZ,
  VSTKZ AS VSTKZ,
  VACKZ AS VACKZ,
  EKORG AS EKORG,
  CLOBK AS CLOBK,
  CLMUL AS CLMUL,
  CLALT AS CLALT,
  CVIEW AS CVIEW,
  KNOBJ AS KNOBJ,
  LGORT AS LGORT,
  KZKUP AS KZKUP,
  INTRM AS INTRM,
  TPEKZ AS TPEKZ,
  STVKN AS STVKN,
  DVDAT AS DVDAT,
  DVNAM AS DVNAM,
  DSPST AS DSPST,
  ALPST AS ALPST,
  ALPRF AS ALPRF,
  ALPGR AS ALPGR,
  KZNFP AS KZNFP,
  NFGRP AS NFGRP,
  NFEAG AS NFEAG,
  KNDVB AS KNDVB,
  KNDBZ AS KNDBZ,
  KSTTY AS KSTTY,
  KSTNR AS KSTNR,
  KSTKN AS KSTKN,
  KSTPZ AS KSTPZ,
  CLSZU AS CLSZU,
  KZCLB AS KZCLB,
  AEHLP AS AEHLP,
  PRVBE AS PRVBE,
  NLFZV AS NLFZV,
  NLFMV AS NLFMV,
  IDPOS AS IDPOS,
  IDHIS AS IDHIS,
  IDVAR AS IDVAR,
  ALEKZ AS ALEKZ,
  ITMID AS ITMID,
  GUID AS GUID,
  ITSOB AS ITSOB,
  RFPNT AS RFPNT,
  GUIDX AS GUIDX
FROM
  STPO"""

df_0 = spark.sql(query_0)

df_0.createOrReplaceTempView("Shortcut_to_STPO_0")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_STPO_1


query_1 = f"""SELECT
  MANDT AS MANDT,
  STLTY AS STLTY,
  STLNR AS STLNR,
  STLKN AS STLKN,
  STPOZ AS STPOZ,
  DATUV AS DATUV,
  TECHV AS TECHV,
  AENNR AS AENNR,
  LKENZ AS LKENZ,
  VGKNT AS VGKNT,
  VGPZL AS VGPZL,
  ANDAT AS ANDAT,
  ANNAM AS ANNAM,
  AEDAT AS AEDAT,
  AENAM AS AENAM,
  IDNRK AS IDNRK,
  PSWRK AS PSWRK,
  POSTP AS POSTP,
  POSNR AS POSNR,
  SORTF AS SORTF,
  MEINS AS MEINS,
  MENGE AS MENGE,
  FMENG AS FMENG,
  AUSCH AS AUSCH,
  AVOAU AS AVOAU,
  NETAU AS NETAU,
  SCHGT AS SCHGT,
  BEIKZ AS BEIKZ,
  ERSKZ AS ERSKZ,
  RVREL AS RVREL,
  SANFE AS SANFE,
  SANIN AS SANIN,
  SANKA AS SANKA,
  SANKO AS SANKO,
  SANVS AS SANVS,
  STKKZ AS STKKZ,
  REKRI AS REKRI,
  REKRS AS REKRS,
  CADPO AS CADPO,
  NFMAT AS NFMAT,
  NLFZT AS NLFZT,
  VERTI AS VERTI,
  ALPOS AS ALPOS,
  EWAHR AS EWAHR,
  EKGRP AS EKGRP,
  LIFZT AS LIFZT,
  LIFNR AS LIFNR,
  PREIS AS PREIS,
  PEINH AS PEINH,
  WAERS AS WAERS,
  SAKTO AS SAKTO,
  ROANZ AS ROANZ,
  ROMS1 AS ROMS1,
  ROMS2 AS ROMS2,
  ROMS3 AS ROMS3,
  ROMEI AS ROMEI,
  ROMEN AS ROMEN,
  RFORM AS RFORM,
  UPSKZ AS UPSKZ,
  VALKZ AS VALKZ,
  LTXSP AS LTXSP,
  POTX1 AS POTX1,
  POTX2 AS POTX2,
  OBJTY AS OBJTY,
  MATKL AS MATKL,
  WEBAZ AS WEBAZ,
  DOKAR AS DOKAR,
  DOKNR AS DOKNR,
  DOKVR AS DOKVR,
  DOKTL AS DOKTL,
  CSSTR AS CSSTR,
  CLASS AS CLASS,
  KLART AS KLART,
  POTPR AS POTPR,
  AWAKZ AS AWAKZ,
  INSKZ AS INSKZ,
  VCEKZ AS VCEKZ,
  VSTKZ AS VSTKZ,
  VACKZ AS VACKZ,
  EKORG AS EKORG,
  CLOBK AS CLOBK,
  CLMUL AS CLMUL,
  CLALT AS CLALT,
  CVIEW AS CVIEW,
  KNOBJ AS KNOBJ,
  LGORT AS LGORT,
  KZKUP AS KZKUP,
  INTRM AS INTRM,
  TPEKZ AS TPEKZ,
  STVKN AS STVKN,
  DVDAT AS DVDAT,
  DVNAM AS DVNAM,
  DSPST AS DSPST,
  ALPST AS ALPST,
  ALPRF AS ALPRF,
  ALPGR AS ALPGR,
  KZNFP AS KZNFP,
  NFGRP AS NFGRP,
  NFEAG AS NFEAG,
  KNDVB AS KNDVB,
  KNDBZ AS KNDBZ,
  KSTTY AS KSTTY,
  KSTNR AS KSTNR,
  KSTKN AS KSTKN,
  KSTPZ AS KSTPZ,
  CLSZU AS CLSZU,
  KZCLB AS KZCLB,
  AEHLP AS AEHLP,
  PRVBE AS PRVBE,
  NLFZV AS NLFZV,
  NLFMV AS NLFMV,
  IDPOS AS IDPOS,
  IDHIS AS IDHIS,
  IDVAR AS IDVAR,
  ALEKZ AS ALEKZ,
  ITMID AS ITMID,
  GUID AS GUID,
  ITSOB AS ITSOB,
  RFPNT AS RFPNT,
  GUIDX AS GUIDX,
  SGT_CMKZ AS SGT_CMKZ,
  SGT_CATV AS SGT_CATV,
  VALID_TO AS VALID_TO,
  VALID_TO_RKEY AS VALID_TO_RKEY,
  ECN_TO AS ECN_TO,
  ECN_TO_RKEY AS ECN_TO_RKEY,
  CUFACTOR AS CUFACTOR,
  FUNCID AS FUNCID,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_STPO_0"""

df_1 = spark.sql(query_1)

df_1.createOrReplaceTempView("SQ_Shortcut_to_STPO_1")

# COMMAND ----------
# DBTITLE 1, SAP_STPO_ff


spark.sql("""INSERT INTO
  SAP_STPO_ff
SELECT
  MANDT AS MANDT,
  STLTY AS STLTY,
  STLNR AS STLNR,
  STLKN AS STLKN,
  STPOZ AS STPOZ,
  DATUV AS DATUV,
  TECHV AS TECHV,
  AENNR AS AENNR,
  LKENZ AS LKENZ,
  VGKNT AS VGKNT,
  VGPZL AS VGPZL,
  ANDAT AS ANDAT,
  ANNAM AS ANNAM,
  AEDAT AS AEDAT,
  AENAM AS AENAM,
  IDNRK AS IDNRK,
  PSWRK AS PSWRK,
  POSTP AS POSTP,
  POSNR AS POSNR,
  SORTF AS SORTF,
  MEINS AS MEINS,
  MENGE AS MENGE,
  FMENG AS FMENG,
  AUSCH AS AUSCH,
  AVOAU AS AVOAU,
  NETAU AS NETAU,
  SCHGT AS SCHGT,
  BEIKZ AS BEIKZ,
  ERSKZ AS ERSKZ,
  RVREL AS RVREL,
  SANFE AS SANFE,
  SANIN AS SANIN,
  SANKA AS SANKA,
  SANKO AS SANKO,
  SANVS AS SANVS,
  STKKZ AS STKKZ,
  REKRI AS REKRI,
  REKRS AS REKRS,
  CADPO AS CADPO,
  NFMAT AS NFMAT,
  NLFZT AS NLFZT,
  VERTI AS VERTI,
  ALPOS AS ALPOS,
  EWAHR AS EWAHR,
  EKGRP AS EKGRP,
  LIFZT AS LIFZT,
  LIFNR AS LIFNR,
  PREIS AS PREIS,
  PEINH AS PEINH,
  WAERS AS WAERS,
  SAKTO AS SAKTO,
  ROANZ AS ROANZ,
  ROMS1 AS ROMS1,
  ROMS2 AS ROMS2,
  ROMS3 AS ROMS3,
  ROMEI AS ROMEI,
  ROMEN AS ROMEN,
  RFORM AS RFORM,
  UPSKZ AS UPSKZ,
  VALKZ AS VALKZ,
  LTXSP AS LTXSP,
  POTX1 AS POTX1,
  POTX2 AS POTX2,
  OBJTY AS OBJTY,
  MATKL AS MATKL,
  WEBAZ AS WEBAZ,
  DOKAR AS DOKAR,
  DOKNR AS DOKNR,
  DOKVR AS DOKVR,
  DOKTL AS DOKTL,
  CSSTR AS CSSTR,
  CLASS AS CLASS,
  KLART AS KLART,
  POTPR AS POTPR,
  AWAKZ AS AWAKZ,
  INSKZ AS INSKZ,
  VCEKZ AS VCEKZ,
  VSTKZ AS VSTKZ,
  VACKZ AS VACKZ,
  EKORG AS EKORG,
  CLOBK AS CLOBK,
  CLMUL AS CLMUL,
  CLALT AS CLALT,
  CVIEW AS CVIEW,
  KNOBJ AS KNOBJ,
  LGORT AS LGORT,
  KZKUP AS KZKUP,
  INTRM AS INTRM,
  TPEKZ AS TPEKZ,
  STVKN AS STVKN,
  DVDAT AS DVDAT,
  DVNAM AS DVNAM,
  DSPST AS DSPST,
  ALPST AS ALPST,
  ALPRF AS ALPRF,
  ALPGR AS ALPGR,
  KZNFP AS KZNFP,
  NFGRP AS NFGRP,
  NFEAG AS NFEAG,
  KNDVB AS KNDVB,
  KNDBZ AS KNDBZ,
  KSTTY AS KSTTY,
  KSTNR AS KSTNR,
  KSTKN AS KSTKN,
  KSTPZ AS KSTPZ,
  CLSZU AS CLSZU,
  KZCLB AS KZCLB,
  AEHLP AS AEHLP,
  PRVBE AS PRVBE,
  NLFZV AS NLFZV,
  NLFMV AS NLFMV,
  IDPOS AS IDPOS,
  IDHIS AS IDHIS,
  IDVAR AS IDVAR,
  ALEKZ AS ALEKZ,
  ITMID AS ITMID,
  GUID AS GUID,
  ITSOB AS ITSOB,
  RFPNT AS RFPNT,
  NULL AS GUIDX,
  SGT_CMKZ AS SGT_CMKZ,
  SGT_CATV AS SGT_CATV,
  VALID_TO AS VALID_TO,
  VALID_TO_RKEY AS VALID_TO_RKEY,
  ECN_TO AS ECN_TO,
  ECN_TO_RKEY AS ECN_TO_RKEY,
  CUFACTOR AS CUFACTOR,
  FUNCID AS FUNCID
FROM
  SQ_Shortcut_to_STPO_1""")

# COMMAND ----------
#Post session variable updation
updateVariable(postVariableAssignment, variablesTableName, mainWorkflowId, parentName, "m_sap_STPO_ff")

# COMMAND ----------
#Update Mapping Variables in database.
persistVariables(variablesTableName, "m_sap_STPO_ff", mainWorkflowId, parentName)
