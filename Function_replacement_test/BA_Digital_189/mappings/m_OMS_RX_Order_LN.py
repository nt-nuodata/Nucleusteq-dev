# Databricks notebook source
# MAGIC %run "./udf_informatica"

# COMMAND ----------


from pyspark.sql.types import *

spark.sql("use DELTA_TRAINING")
spark.sql("set spark.sql.legacy.timeParserPolicy = LEGACY")

# COMMAND ----------
%run ../WorkflowUtility

# COMMAND ----------
mainWorkflowId = dbutils.widgets.get("mainWorkflowId")
mainWorkflowRunId = dbutils.widgets.get("mainWorkflowRunId")
parentName = dbutils.widgets.get("parentName")
preVariableAssignment = dbutils.widgets.get("preVariableAssignment")
postVariableAssignment = dbutils.widgets.get("postVariableAssignment")
truncTargetTableOptions = dbutils.widgets.get("truncTargetTableOptions")
variablesTableName = dbutils.widgets.get("variablesTableName")

# COMMAND ----------
#Truncate Target Tables
truncateTargetTables(truncTargetTableOptions)

# COMMAND ----------
#Pre presession variable updation
updateVariable(preVariableAssignment, variablesTableName, mainWorkflowId, parentName, "m_OMS_RX_Order_LN")

# COMMAND ----------
fetchAndCreateVariables(parentName,"m_OMS_RX_Order_LN", variablesTableName, mainWorkflowId)

# COMMAND ----------
# DBTITLE 1, LKP_PET_GENDER


spark.sql(
  """CREATE OR REPLACE FUNCTION LKP_PET_GENDER (in_PET_GENDER_ID INT)
RETURNS STRING
READS SQL DATA SQL SECURITY DEFINER
RETURN SELECT FIRST(PET_GENDER_DESC) FROM PET_GENDER WHERE PET_GENDER_ID = in_PET_GENDER_ID"""
)

# COMMAND ----------
# DBTITLE 1, LKP_PET_ALLERGIES


spark.sql(
  """CREATE OR REPLACE FUNCTION LKP_PET_ALLERGIES (in_PET_ALLERGY_ID INT)
RETURNS STRING
READS SQL DATA SQL SECURITY DEFINER
RETURN SELECT FIRST(PET_ALLERGY_DESC) FROM PET_ALLERGIES WHERE PET_ALLERGY_ID = in_PET_ALLERGY_ID"""
)

# COMMAND ----------
# DBTITLE 1, LKP_PET_CONDITION


spark.sql(
  """CREATE OR REPLACE FUNCTION LKP_PET_CONDITION (in_PET_CONDITION_ID INT)
RETURNS STRING
READS SQL DATA SQL SECURITY DEFINER
RETURN SELECT FIRST(PET_CONDITION_DESC) FROM PET_CONDITION WHERE PET_CONDITION_ID = in_PET_CONDITION_ID"""
)

# COMMAND ----------
# DBTITLE 1, LKP_PET_BREED


spark.sql(
  """CREATE OR REPLACE FUNCTION LKP_PET_BREED (in_PET_BREED_ID INT)
RETURNS STRING
READS SQL DATA SQL SECURITY DEFINER
RETURN SELECT FIRST(PET_BREED_DESC) FROM PET_BREED WHERE PET_BREED_ID = in_PET_BREED_ID"""
)

# COMMAND ----------
# DBTITLE 1, LKP_PET_MEDICATION


spark.sql(
  """CREATE OR REPLACE FUNCTION LKP_PET_MEDICATION (in_PET_MEDICATION_ID INT)
RETURNS STRING
READS SQL DATA SQL SECURITY DEFINER
RETURN SELECT FIRST(PET_MEDICATION_DESC) FROM PET_MEDICATION WHERE PET_MEDICATION_ID = in_PET_MEDICATION_ID"""
)

# COMMAND ----------
# DBTITLE 1, LKP_PET_TYPE


spark.sql(
  """CREATE OR REPLACE FUNCTION LKP_PET_TYPE (in_PET_SPECIES_ID INT)
RETURNS STRING
READS SQL DATA SQL SECURITY DEFINER
RETURN SELECT FIRST(PET_SPECIES_DESC) FROM PET_SPECIES WHERE PET_SPECIES_ID = in_PET_SPECIES_ID"""
)

# COMMAND ----------
# DBTITLE 1, Shortcut_to_OMS_A_CO_NOTE_6


query_6 = f"""SELECT
  OMS_NOTE_ID AS OMS_NOTE_ID,
  OMS_ENTITY_ID AS OMS_ENTITY_ID,
  OMS_ENTITY_LINE_ID AS OMS_ENTITY_LINE_ID,
  OMS_NOTE_TYPE_ID AS OMS_NOTE_TYPE_ID,
  NOTE_SEQ AS NOTE_SEQ,
  NOTE_DESC AS NOTE_DESC,
  OMS_CREATED_TSTMP AS OMS_CREATED_TSTMP,
  OMS_LAST_UPDATED_TSTMP AS OMS_LAST_UPDATED_TSTMP,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP
FROM
  OMS_A_CO_NOTE"""

df_6 = spark.sql(query_6)

df_6.createOrReplaceTempView("Shortcut_to_OMS_A_CO_NOTE_6")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_OMS_A_CO_NOTE_7


query_7 = f"""SELECT
  OMS_ENTITY_ID AS OMS_ENTITY_ID,
  OMS_ENTITY_LINE_ID AS OMS_ENTITY_LINE_ID,
  NOTE_DESC AS NOTE_DESC,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_OMS_A_CO_NOTE_6"""

df_7 = spark.sql(query_7)

df_7.createOrReplaceTempView("SQ_Shortcut_to_OMS_A_CO_NOTE_7")

# COMMAND ----------
# DBTITLE 1, Shortcut_to_OMS_EDW_LOAD_CTRL_PRE_8


query_8 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  OMS_TC_COMPANY_ID AS OMS_TC_COMPANY_ID,
  ORDER_NBR AS ORDER_NBR,
  OMS_TC_PURCHASE_ORDERS_ID AS OMS_TC_PURCHASE_ORDERS_ID,
  OMS_TC_PO_LINE_ID AS OMS_TC_PO_LINE_ID,
  OMS_ORDER_FULFILLMENT_OPTION AS OMS_ORDER_FULFILLMENT_OPTION,
  ORDER_FULFILLMENT_CHANNEL AS ORDER_FULFILLMENT_CHANNEL,
  ORDER_CREATION_CHANNEL AS ORDER_CREATION_CHANNEL,
  ORDER_CHANNEL AS ORDER_CHANNEL,
  OMS_CREATED_SOURCE AS OMS_CREATED_SOURCE,
  OMS_ENTERED_BY AS OMS_ENTERED_BY,
  OMS_ROLE_NAME AS OMS_ROLE_NAME,
  PO_OMS_CREATED_TSTMP AS PO_OMS_CREATED_TSTMP,
  PO_OMS_LAST_UPDATED_DTTM AS PO_OMS_LAST_UPDATED_DTTM,
  POL_OMS_CREATED_TSTMP AS POL_OMS_CREATED_TSTMP,
  POL_OMS_LAST_UPDATED_TSTMP AS POL_OMS_LAST_UPDATED_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP
FROM
  OMS_EDW_LOAD_CTRL_PRE"""

df_8 = spark.sql(query_8)

df_8.createOrReplaceTempView("Shortcut_to_OMS_EDW_LOAD_CTRL_PRE_8")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_OMS_EDW_LOAD_CTRL_PRE_9


query_9 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_OMS_EDW_LOAD_CTRL_PRE_8"""

df_9 = spark.sql(query_9)

df_9.createOrReplaceTempView("SQ_Shortcut_to_OMS_EDW_LOAD_CTRL_PRE_9")

# COMMAND ----------
# DBTITLE 1, Shortcut_to_OMS_PO_LINE_ITEM_REF_FIELDS_10


query_10 = f"""SELECT
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  REF_FIELD1 AS REF_FIELD1,
  REF_FIELD2 AS REF_FIELD2,
  REF_FIELD3 AS REF_FIELD3,
  REF_FIELD4 AS REF_FIELD4,
  REF_FIELD5 AS REF_FIELD5,
  REF_FIELD6 AS REF_FIELD6,
  REF_FIELD7 AS REF_FIELD7,
  REF_FIELD8 AS REF_FIELD8,
  REF_FIELD9 AS REF_FIELD9,
  REF_FIELD10 AS REF_FIELD10,
  REF_NUM1 AS REF_NUM1,
  REF_NUM2 AS REF_NUM2,
  REF_NUM3 AS REF_NUM3,
  REF_NUM4 AS REF_NUM4,
  REF_NUM5 AS REF_NUM5,
  RX_STATUS AS RX_STATUS,
  RX_ASSIGNED_TO AS RX_ASSIGNED_TO,
  RX_ASSIGNED_TSTMP AS RX_ASSIGNED_TSTMP,
  RX_VET_INQUIRY AS RX_VET_INQUIRY,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP
FROM
  OMS_PO_LINE_ITEM_REF_FIELDS"""

df_10 = spark.sql(query_10)

df_10.createOrReplaceTempView("Shortcut_to_OMS_PO_LINE_ITEM_REF_FIELDS_10")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_OMS_PO_LINE_ITEM_REF_FIELDS_11


query_11 = f"""SELECT
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  REF_FIELD4 AS REF_FIELD4,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_OMS_PO_LINE_ITEM_REF_FIELDS_10
WHERE
  REF_FIELD4 IS NOT NULL"""

df_11 = spark.sql(query_11)

df_11.createOrReplaceTempView("SQ_Shortcut_to_OMS_PO_LINE_ITEM_REF_FIELDS_11")

# COMMAND ----------
# DBTITLE 1, JNR_MASTER_ORDER_12


query_12 = f"""SELECT
  DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  DETAIL.OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  DETAIL.REF_FIELD4 AS REF_FIELD4,
  MASTER.OMS_PURCHASE_ORDERS_ID AS mo_OMS_PURCHASE_ORDERS_ID,
  MASTER.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS mo_OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  DETAIL.UPDATE_TSTMP AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS,
  MASTER.Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  SQ_Shortcut_to_OMS_EDW_LOAD_CTRL_PRE_9 MASTER
  INNER JOIN SQ_Shortcut_to_OMS_PO_LINE_ITEM_REF_FIELDS_11 DETAIL ON MASTER.OMS_PURCHASE_ORDERS_ID = DETAIL.OMS_PURCHASE_ORDERS_ID
  AND MASTER.OMS_PURCHASE_ORDERS_LINE_ITEM_ID = DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID"""

df_12 = spark.sql(query_12)

df_12.createOrReplaceTempView("JNR_MASTER_ORDER_12")

# COMMAND ----------
# DBTITLE 1, Shortcut_to_OMS_PO_LINE_ITEM_ATTRIBUTE_13


query_13 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  ATTRIBUTE_NAME AS ATTRIBUTE_NAME,
  ATTRIBUTE_SEQ AS ATTRIBUTE_SEQ,
  ATTRIBUTE_VALUE AS ATTRIBUTE_VALUE,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP
FROM
  OMS_PO_LINE_ITEM_ATTRIBUTE"""

df_13 = spark.sql(query_13)

df_13.createOrReplaceTempView("Shortcut_to_OMS_PO_LINE_ITEM_ATTRIBUTE_13")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_OMS_PO_LINE_ITEM_ATTRIBUTE_14


query_14 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  ATTRIBUTE_NAME AS ATTRIBUTE_NAME,
  ATTRIBUTE_SEQ AS ATTRIBUTE_SEQ,
  ATTRIBUTE_VALUE AS ATTRIBUTE_VALUE,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_OMS_PO_LINE_ITEM_ATTRIBUTE_13"""

df_14 = spark.sql(query_14)

df_14.createOrReplaceTempView("SQ_Shortcut_to_OMS_PO_LINE_ITEM_ATTRIBUTE_14")

# COMMAND ----------
# DBTITLE 1, JNR_PO_LINE_ITEM_ATTRIBUTE_15


query_15 = f"""SELECT
  DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  DETAIL.OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  DETAIL.REF_FIELD4 AS REF_FIELD4,
  DETAIL.UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS,
  MASTER.OMS_PURCHASE_ORDERS_ID AS attr_OMS_PURCHASE_ORDERS_ID,
  MASTER.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS attr_OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  MASTER.ATTRIBUTE_NAME AS attr_ATTRIBUTE_NAME,
  MASTER.ATTRIBUTE_SEQ AS attr_ATTRIBUTE_SEQ,
  MASTER.ATTRIBUTE_VALUE AS attr_ATTRIBUTE_VALUE,
  MASTER.UPDATE_TSTMP AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE,
  MASTER.Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  SQ_Shortcut_to_OMS_PO_LINE_ITEM_ATTRIBUTE_14 MASTER
  INNER JOIN JNR_MASTER_ORDER_12 DETAIL ON MASTER.OMS_PURCHASE_ORDERS_ID = DETAIL.OMS_PURCHASE_ORDERS_ID
  AND MASTER.OMS_PURCHASE_ORDERS_LINE_ITEM_ID = DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID"""

df_15 = spark.sql(query_15)

df_15.createOrReplaceTempView("JNR_PO_LINE_ITEM_ATTRIBUTE_15")

# COMMAND ----------
# DBTITLE 1, Shortcut_to_OMS_PURCHASE_ORDERS_LINE_ITEM_16


query_16 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  OMS_TC_PO_LINE_ID AS OMS_TC_PO_LINE_ID,
  OMS_PARENT_PO_LINE_ITEM_ID AS OMS_PARENT_PO_LINE_ITEM_ID,
  OMS_ORIGINAL_PO_LINE_ITEM_ID AS OMS_ORIGINAL_PO_LINE_ITEM_ID,
  OMS_PURCHASE_ORDERS_LINE_STATUS_ID AS OMS_PURCHASE_ORDERS_LINE_STATUS_ID,
  ORDER_FULFILLMENT_OPTION_ID AS ORDER_FULFILLMENT_OPTION_ID,
  SKU AS SKU,
  CUST_SKU AS CUST_SKU,
  OMS_PRODUCT_CLASS_ID AS OMS_PRODUCT_CLASS_ID,
  RETURNABLE_FLAG AS RETURNABLE_FLAG,
  EXCHANGEABLE_FLAG AS EXCHANGEABLE_FLAG,
  PRICE_OVERRIDE_FLAG AS PRICE_OVERRIDE_FLAG,
  OMS_STORE_FACILITY_ALIAS_ID AS OMS_STORE_FACILITY_ALIAS_ID,
  OMS_STORE_FACILITY_ID AS OMS_STORE_FACILITY_ID,
  OMS_O_FACILITY_ID AS OMS_O_FACILITY_ID,
  OMS_O_FACILITY_ALIAS_ID AS OMS_O_FACILITY_ALIAS_ID,
  OMS_BILL_FACILITY_ALIAS_ID AS OMS_BILL_FACILITY_ALIAS_ID,
  OMS_BILL_FACILITY_ID AS OMS_BILL_FACILITY_ID,
  OMS_D_FACILITY_ID AS OMS_D_FACILITY_ID,
  OMS_D_FACILITY_ALIAS_ID AS OMS_D_FACILITY_ALIAS_ID,
  D_FIRST_NAME AS D_FIRST_NAME,
  D_LAST_NAME AS D_LAST_NAME,
  D_ADDR_1 AS D_ADDR_1,
  D_ADDR_2 AS D_ADDR_2,
  D_ADDR_3 AS D_ADDR_3,
  D_CITY AS D_CITY,
  D_STATE_PROV AS D_STATE_PROV,
  D_POSTAL_CD AS D_POSTAL_CD,
  D_COUNTY AS D_COUNTY,
  D_COUNTRY_CD AS D_COUNTRY_CD,
  D_PHONE_NBR AS D_PHONE_NBR,
  D_EMAIL AS D_EMAIL,
  ADDR_VALID_FLAG AS ADDR_VALID_FLAG,
  OMS_ALLOC_FINALIZER AS OMS_ALLOC_FINALIZER,
  OMS_DSG_CARRIER_ID AS OMS_DSG_CARRIER_ID,
  DSG_SHIP_VIA AS DSG_SHIP_VIA,
  DO_CREATED_FLAG AS DO_CREATED_FLAG,
  READY_TO_SHIP_FLAG AS READY_TO_SHIP_FLAG,
  CANCELLED_FLAG AS CANCELLED_FLAG,
  CLOSED_FLAG AS CLOSED_FLAG,
  DELETED_FLAG AS DELETED_FLAG,
  OMS_REASON_ID AS OMS_REASON_ID,
  OMS_REASON_CODES_GROUP_ID AS OMS_REASON_CODES_GROUP_ID,
  OMS_BACK_ORD_REASON_ID AS OMS_BACK_ORD_REASON_ID,
  OMS_PICKUP_START_TSTMP AS OMS_PICKUP_START_TSTMP,
  OMS_PICKUP_END_TSTMP AS OMS_PICKUP_END_TSTMP,
  OMS_PICKUP_TZ_ID AS OMS_PICKUP_TZ_ID,
  OMS_DELIVERY_START_TSTMP AS OMS_DELIVERY_START_TSTMP,
  OMS_DELIVERY_END_TSTMP AS OMS_DELIVERY_END_TSTMP,
  OMS_DELIVERY_TZ_ID AS OMS_DELIVERY_TZ_ID,
  OMS_REQ_DLVR_TSTMP AS OMS_REQ_DLVR_TSTMP,
  OMS_MUST_DLVR_TSTMP AS OMS_MUST_DLVR_TSTMP,
  OMS_SHIP_BY_DT AS OMS_SHIP_BY_DT,
  ORIG_ORDER_QTY AS ORIG_ORDER_QTY,
  ORDER_QTY AS ORDER_QTY,
  CANCELLED_QTY AS CANCELLED_QTY,
  ALLOCATED_QTY AS ALLOCATED_QTY,
  RELEASED_QTY AS RELEASED_QTY,
  RECEIVED_QTY AS RECEIVED_QTY,
  PPACK_QTY AS PPACK_QTY,
  SHIPPED_QTY AS SHIPPED_QTY,
  ORIGINAL_PRICE_AMT AS ORIGINAL_PRICE_AMT,
  RETAIL_PRICE_AMT AS RETAIL_PRICE_AMT,
  UNIT_TAX_AMT AS UNIT_TAX_AMT,
  LINE_TOTAL_AMT AS LINE_TOTAL_AMT,
  UNIT_MONETARY_VALUE AS UNIT_MONETARY_VALUE,
  TOTAL_MONETARY_VALUE AS TOTAL_MONETARY_VALUE,
  MV_CURRENCY_CD AS MV_CURRENCY_CD,
  OMS_EXT_CREATED_TSTMP AS OMS_EXT_CREATED_TSTMP,
  OMS_CREATED_SOURCE_TYPE_ID AS OMS_CREATED_SOURCE_TYPE_ID,
  OMS_CREATED_SOURCE AS OMS_CREATED_SOURCE,
  OMS_CREATED_TSTMP AS OMS_CREATED_TSTMP,
  OMS_LAST_UPDATED_TSTMP AS OMS_LAST_UPDATED_TSTMP,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP
FROM
  OMS_PURCHASE_ORDERS_LINE_ITEM"""

df_16 = spark.sql(query_16)

df_16.createOrReplaceTempView("Shortcut_to_OMS_PURCHASE_ORDERS_LINE_ITEM_16")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_OMS_PURCHASE_ORDERS_LINE_ITEM_17


query_17 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  SKU AS SKU,
  CUST_SKU AS CUST_SKU,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_OMS_PURCHASE_ORDERS_LINE_ITEM_16"""

df_17 = spark.sql(query_17)

df_17.createOrReplaceTempView("SQ_Shortcut_to_OMS_PURCHASE_ORDERS_LINE_ITEM_17")

# COMMAND ----------
# DBTITLE 1, JNR_PURCHASE_ORDERS_LINE_ITEM_18


query_18 = f"""SELECT
  DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  DETAIL.OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  DETAIL.REF_FIELD4 AS REF_FIELD4,
  DETAIL.attr_ATTRIBUTE_NAME AS attr_ATTRIBUTE_NAME,
  DETAIL.attr_ATTRIBUTE_SEQ AS attr_ATTRIBUTE_SEQ,
  DETAIL.attr_ATTRIBUTE_VALUE AS attr_ATTRIBUTE_VALUE,
  MASTER.OMS_PURCHASE_ORDERS_ID AS po_OMS_PURCHASE_ORDERS_ID,
  MASTER.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS po_OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  MASTER.SKU AS po_SKU,
  MASTER.CUST_SKU AS po_CUST_SKU,
  MASTER.UPDATE_TSTMP AS UPDATE_TSTMP_OMS_PURCHASE_ORDERS_LINE_ITEM,
  DETAIL.UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS,
  DETAIL.UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE,
  MASTER.Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  SQ_Shortcut_to_OMS_PURCHASE_ORDERS_LINE_ITEM_17 MASTER
  INNER JOIN JNR_PO_LINE_ITEM_ATTRIBUTE_15 DETAIL ON MASTER.OMS_PURCHASE_ORDERS_ID = DETAIL.OMS_PURCHASE_ORDERS_ID
  AND MASTER.OMS_PURCHASE_ORDERS_LINE_ITEM_ID = DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID"""

df_18 = spark.sql(query_18)

df_18.createOrReplaceTempView("JNR_PURCHASE_ORDERS_LINE_ITEM_18")

# COMMAND ----------
# DBTITLE 1, JNR_A_CO_NOTE_19


query_19 = f"""SELECT
  DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  DETAIL.OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  DETAIL.REF_FIELD4 AS REF_FIELD4,
  DETAIL.attr_ATTRIBUTE_NAME AS attr_ATTRIBUTE_NAME,
  DETAIL.attr_ATTRIBUTE_SEQ AS attr_ATTRIBUTE_SEQ,
  DETAIL.attr_ATTRIBUTE_VALUE AS attr_ATTRIBUTE_VALUE,
  DETAIL.po_SKU AS po_SKU,
  DETAIL.po_CUST_SKU AS po_CUST_SKU,
  MASTER.OMS_ENTITY_ID AS OMS_ENTITY_ID,
  MASTER.OMS_ENTITY_LINE_ID AS OMS_ENTITY_LINE_ID,
  MASTER.NOTE_DESC AS NOTE_DESC,
  MASTER.UPDATE_TSTMP AS UPDATE_TSTMP_OMS_A_CO_NOTE,
  DETAIL.UPDATE_TSTMP_OMS_PURCHASE_ORDERS_LINE_ITEM AS UPDATE_TSTMP_OMS_PURCHASE_ORDERS_LINE_ITEM,
  DETAIL.UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS,
  DETAIL.UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE,
  DETAIL.Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  SQ_Shortcut_to_OMS_A_CO_NOTE_7 MASTER
  RIGHT JOIN JNR_PURCHASE_ORDERS_LINE_ITEM_18 DETAIL ON MASTER.OMS_ENTITY_ID = DETAIL.OMS_PURCHASE_ORDERS_ID
  AND MASTER.OMS_ENTITY_LINE_ID = DETAIL.OMS_PURCHASE_ORDERS_LINE_ITEM_ID"""

df_19 = spark.sql(query_19)

df_19.createOrReplaceTempView("JNR_A_CO_NOTE_19")

# COMMAND ----------
# DBTITLE 1, FLT_UPDATE_TSTMP_20


query_20 = f"""SELECT
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  REF_FIELD4 AS REF_FIELD4,
  attr_ATTRIBUTE_NAME AS attr_ATTRIBUTE_NAME,
  attr_ATTRIBUTE_SEQ AS attr_ATTRIBUTE_SEQ,
  attr_ATTRIBUTE_VALUE AS attr_ATTRIBUTE_VALUE,
  po_SKU AS po_SKU,
  po_CUST_SKU AS po_CUST_SKU,
  NOTE_DESC AS NOTE_DESC,
  UPDATE_TSTMP_OMS_A_CO_NOTE AS UPDATE_TSTMP_OMS_A_CO_NOTE,
  UPDATE_TSTMP_OMS_PURCHASE_ORDERS_LINE_ITEM AS UPDATE_TSTMP_OMS_PURCHASE_ORDERS_LINE_ITEM,
  UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS,
  UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE AS UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  JNR_A_CO_NOTE_19
WHERE
  UPDATE_TSTMP_OMS_A_CO_NOTE > (TRUNC(now()))
  OR UPDATE_TSTMP_OMS_PURCHASE_ORDERS_LINE_ITEM > (TRUNC(now()))
  OR UPDATE_TSTMP_OMS_PO_LINE_ITEM_REF_FIELDS > (TRUNC(now()))
  OR UPDATE_TSTMP_OMS_PO_LINE_ITEM_ATTRIBUTE > (TRUNC(now()))"""

df_20 = spark.sql(query_20)

df_20.createOrReplaceTempView("FLT_UPDATE_TSTMP_20")

# COMMAND ----------
# DBTITLE 1, SRT_by_PO_Line_Item_21


query_21 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_PURCHASE_ORDERS_LINE_ITEM_ID,
  po_CUST_SKU AS po_CUST_SKU,
  po_SKU AS po_SKU,
  REF_FIELD4 AS REF_FIELD4,
  attr_ATTRIBUTE_NAME AS attr_ATTRIBUTE_NAME,
  attr_ATTRIBUTE_SEQ AS attr_ATTRIBUTE_SEQ,
  attr_ATTRIBUTE_VALUE AS attr_ATTRIBUTE_VALUE,
  NOTE_DESC AS NOTE_DESC,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  FLT_UPDATE_TSTMP_20
ORDER BY
  OMS_PURCHASE_ORDERS_ID ASC,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID ASC"""

df_21 = spark.sql(query_21)

df_21.createOrReplaceTempView("SRT_by_PO_Line_Item_21")

# COMMAND ----------
# DBTITLE 1, AGG_byPO_Line_Item_22


query_22 = f"""SELECT
  OMS_PURCHASE_ORDERS_ID AS OMS_ORDER_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID AS OMS_ORDER_LINE_ID,
  max(po_CUST_SKU) AS RX_SKU,
  max(po_SKU) AS SKU,
  max(REF_FIELD4) AS RX_STATUS,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetName',
      attr_ATTRIBUTE_VALUE
    )
  ) AS PET_NAME,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetType',
      attr_ATTRIBUTE_VALUE
    )
  ) AS OMS_PET_TYPE_ID,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetBreed',
      attr_ATTRIBUTE_VALUE
    )
  ) AS OMS_PET_BREED_ID,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetWeight',
      attr_ATTRIBUTE_VALUE
    )
  ) AS PET_WEIGHT,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetDob',
      attr_ATTRIBUTE_VALUE
    )
  ) AS PET_BIRTH_DT,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetAge',
      attr_ATTRIBUTE_VALUE
    )
  ) AS PET_AGE,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetGender',
      attr_ATTRIBUTE_VALUE
    )
  ) AS OMS_PET_GENDER_ID,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetRXNotes',
      attr_ATTRIBUTE_VALUE
    )
  ) AS PET_RX_NOTES,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetName',
      attr_ATTRIBUTE_VALUE
    )
  ) AS VET_NAME,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetBusinessName',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_NAME,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetAddress',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_ADDRESS_1,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetCity',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_CITY,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetState',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_STATE_PROV_CD,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetPhone',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_PHONE,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetEmail',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_EMAIL,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetFax',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_FAX,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_VetClinicHIN',
      attr_ATTRIBUTE_VALUE
    )
  ) AS CLINIC_CLINIC_HIN,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_ContactVet'
      and (
        rtrim(attr_ATTRIBUTE_VALUE) = '0'
        or rtrim(attr_ATTRIBUTE_VALUE) = '1'
      ),
      attr_ATTRIBUTE_VALUE
    )
  ) AS RX_CONTACT_VET_FLAG,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PetOwnerName',
      attr_ATTRIBUTE_VALUE
    )
  ) AS PET_OWNER_NAME,
  max(
    IFF(
      rtrim(attr_ATTRIBUTE_NAME) = 'RX_PharmacyType',
      attr_ATTRIBUTE_VALUE
    )
  ) AS RX_TYPE,
  max(
    IFF(
      instr(NOTE_DESC, 'Pet Medications|') > 0,
      substr(
        NOTE_DESC,
        length('Pet Medications|') + 1,
        length(NOTE_DESC)
      ),
      NULL
    )
  ) AS PET_MEDICATIONS,
  max(
    IFF(
      instr(NOTE_DESC, 'Pet Allergies|') > 0,
      substr(
        NOTE_DESC,
        length('Pet Allergies|') + 1,
        length(NOTE_DESC)
      ),
      NULL
    )
  ) AS PET_ALLERGIES,
  max(
    IFF(
      instr(NOTE_DESC, 'Medical Conditions|') > 0,
      substr(
        NOTE_DESC,
        length('Medical Conditions|') + 1,
        length(NOTE_DESC)
      ),
      NULL
    )
  ) AS PET_MEDICAL_CONDITION,
  max(
    IFF(
      instr(NOTE_DESC, 'Medication Allergies|') > 0,
      substr(
        NOTE_DESC,
        length('Medication Allergies|') + 1,
        length(NOTE_DESC)
      ),
      NULL
    )
  ) AS PET_MEDICATION_ALLERGIES,
  last(Monotonically_Increasing_Id) AS Monotonically_Increasing_Id
FROM
  SRT_by_PO_Line_Item_21
GROUP BY
  OMS_PURCHASE_ORDERS_ID,
  OMS_PURCHASE_ORDERS_LINE_ITEM_ID"""

df_22 = spark.sql(query_22)

df_22.createOrReplaceTempView("AGG_byPO_Line_Item_22")

# COMMAND ----------
# DBTITLE 1, EXP_PASS_THROUGH_23


query_23 = f"""SELECT
  OMS_ORDER_ID AS OMS_ORDER_ID,
  OMS_ORDER_LINE_ID AS OMS_ORDER_LINE_ID,
  TO_INTEGER(SKU) AS o_PRODUCT_ID,
  RX_SKU AS RX_SKU,
  RX_STATUS AS RX_STATUS,
  PET_NAME AS PET_NAME,
  OMS_PET_TYPE_ID AS OMS_PET_TYPE_ID,
  OMS_PET_BREED_ID AS OMS_PET_BREED_ID,
  PET_WEIGHT AS PET_WEIGHT,
  PET_BIRTH_DT AS PET_BIRTH_DT,
  PET_AGE AS PET_AGE,
  OMS_PET_GENDER_ID AS OMS_PET_GENDER_ID,
  PET_RX_NOTES AS PET_RX_NOTES,
  VET_NAME AS VET_NAME,
  CLINIC_NAME AS CLINIC_NAME,
  CLINIC_ADDRESS_1 AS CLINIC_ADDRESS_1,
  CLINIC_CITY AS CLINIC_CITY,
  CLINIC_STATE_PROV_CD AS CLINIC_STATE_PROV_CD,
  CLINIC_PHONE AS CLINIC_PHONE,
  CLINIC_EMAIL AS CLINIC_EMAIL,
  CLINIC_FAX AS CLINIC_FAX,
  CLINIC_CLINIC_HIN AS CLINIC_CLINIC_HIN,
  RX_CONTACT_VET_FLAG AS RX_CONTACT_VET_FLAG,
  PET_OWNER_NAME AS PET_OWNER_NAME,
  RX_TYPE AS RX_TYPE,
  PET_MEDICATIONS AS PET_MEDICATIONS,
  PET_ALLERGIES AS PET_ALLERGIES,
  PET_MEDICAL_CONDITION AS PET_MEDICAL_CONDITION,
  PET_MEDICATION_ALLERGIES AS PET_MEDICATION_ALLERGIES,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  AGG_byPO_Line_Item_22"""

df_23 = spark.sql(query_23)

df_23.createOrReplaceTempView("EXP_PASS_THROUGH_23")

# COMMAND ----------
# DBTITLE 1, LKP_SKU_PROFILE_24


query_24 = f"""SELECT
  SP.PRODUCT_ID AS PRODUCT_ID,
  EPT2.OMS_ORDER_ID AS OMS_ORDER_ID,
  EPT2.OMS_ORDER_LINE_ID AS OMS_ORDER_LINE_ID,
  EPT2.RX_SKU AS RX_SKU,
  EPT2.RX_STATUS AS RX_STATUS,
  EPT2.PET_NAME AS PET_NAME,
  EPT2.OMS_PET_TYPE_ID AS OMS_PET_TYPE_ID,
  EPT2.OMS_PET_BREED_ID AS OMS_PET_BREED_ID,
  EPT2.PET_WEIGHT AS PET_WEIGHT,
  EPT2.PET_BIRTH_DT AS PET_BIRTH_DT,
  EPT2.PET_AGE AS PET_AGE,
  EPT2.OMS_PET_GENDER_ID AS OMS_PET_GENDER_ID,
  EPT2.PET_RX_NOTES AS PET_RX_NOTES,
  EPT2.VET_NAME AS VET_NAME,
  EPT2.CLINIC_NAME AS CLINIC_NAME,
  EPT2.CLINIC_ADDRESS_1 AS CLINIC_ADDRESS_1,
  EPT2.CLINIC_CITY AS CLINIC_CITY,
  EPT2.CLINIC_STATE_PROV_CD AS CLINIC_STATE_PROV_CD,
  EPT2.CLINIC_PHONE AS CLINIC_PHONE,
  EPT2.CLINIC_EMAIL AS CLINIC_EMAIL,
  EPT2.CLINIC_FAX AS CLINIC_FAX,
  EPT2.CLINIC_CLINIC_HIN AS CLINIC_CLINIC_HIN,
  EPT2.RX_CONTACT_VET_FLAG AS RX_CONTACT_VET_FLAG,
  EPT2.PET_OWNER_NAME AS PET_OWNER_NAME,
  EPT2.RX_TYPE AS RX_TYPE,
  EPT2.PET_MEDICATIONS AS PET_MEDICATIONS,
  EPT2.PET_ALLERGIES AS PET_ALLERGIES,
  EPT2.PET_MEDICAL_CONDITION AS PET_MEDICAL_CONDITION,
  EPT2.PET_MEDICATION_ALLERGIES AS PET_MEDICATION_ALLERGIES,
  EPT2.Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  EXP_PASS_THROUGH_23 EPT2
  LEFT JOIN SKU_PROFILE SP ON SP.SKU_NBR = EPT2.o_PRODUCT_ID"""

df_24 = spark.sql(query_24)

df_24.createOrReplaceTempView("LKP_SKU_PROFILE_24")

# COMMAND ----------
# DBTITLE 1, EXP_PRE_25


query_25 = f"""SELECT
  TO_INTEGER(OMS_ORDER_ID) AS o_OMS_ORDER_ID,
  TO_INTEGER(OMS_ORDER_LINE_ID) AS o_OMS_ORDER_LINE_ID,
  PRODUCT_ID AS PRODUCT_ID,
  RX_SKU AS RX_SKU,
  RX_STATUS AS RX_STATUS,
  PET_NAME AS PET_NAME,
  IFF(
    ISNULL(OMS_PET_TYPE_ID),
    NULL,
    (
      IFF(
        IS_NUMBER(OMS_PET_TYPE_ID),
        TO_INTEGER(OMS_PET_TYPE_ID),
        NULL
      )
    )
  ) AS o_OMS_PET_TYPE_ID,
  IFF(
    ISNULL(OMS_PET_BREED_ID),
    NULL,
    (
      IFF(
        IS_NUMBER(OMS_PET_BREED_ID),
        TO_INTEGER(OMS_PET_BREED_ID),
        NULL
      )
    )
  ) AS o_OMS_PET_BREED_ID,
  IFF(
    ISNULL(PET_WEIGHT),
    NULL,
    (
      IFF(
        IS_NUMBER(PET_WEIGHT),
        TO_INTEGER(PET_WEIGHT),
        NULL
      )
    )
  ) AS o_PET_WEIGHT,
  IFF(
    is_date(REPLACESTR(1, PET_BIRTH_DT, '-', NULL), 'yyyymmdd') = 1,
    to_date(REPLACESTR(1, PET_BIRTH_DT, '-', NULL), 'yyyymmdd')
  ) AS o_PET_BIRTH_DT,
  IFF(
    ISNULL(PET_AGE),
    NULL,
    (IFF(IS_NUMBER(PET_AGE), TO_INTEGER(PET_AGE), NULL))
  ) AS o_PET_AGE,
  IFF(
    ISNULL(OMS_PET_GENDER_ID),
    NULL,
    (
      IFF(
        IS_NUMBER(OMS_PET_GENDER_ID),
        TO_INTEGER(OMS_PET_GENDER_ID),
        NULL
      )
    )
  ) AS o_OMS_PET_GENDER_ID,
  PET_RX_NOTES AS PET_RX_NOTES,
  VET_NAME AS VET_NAME,
  CLINIC_NAME AS CLINIC_NAME,
  CLINIC_ADDRESS_1 AS CLINIC_ADDRESS_1,
  CLINIC_CITY AS CLINIC_CITY,
  CLINIC_STATE_PROV_CD AS CLINIC_STATE_PROV_CD,
  CLINIC_PHONE AS CLINIC_PHONE,
  CLINIC_EMAIL AS CLINIC_EMAIL,
  CLINIC_FAX AS CLINIC_FAX,
  IFF(
    ISNULL(CLINIC_CLINIC_HIN),
    NULL,
    (
      IFF(
        IS_NUMBER(CLINIC_CLINIC_HIN),
        TO_INTEGER(CLINIC_CLINIC_HIN),
        NULL
      )
    )
  ) AS o_CLINIC_CLINIC_HIN,
  IFF(
    ISNULL(RX_CONTACT_VET_FLAG),
    NULL,
    (
      IFF(
        IS_NUMBER(RX_CONTACT_VET_FLAG),
        TO_INTEGER(RX_CONTACT_VET_FLAG),
        NULL
      )
    )
  ) AS o_RX_CONTACT_VET_FLAG,
  PET_OWNER_NAME AS PET_OWNER_NAME,
  RX_TYPE AS RX_TYPE,
  PET_MEDICATIONS AS PET_MEDICATIONS,
  PET_ALLERGIES AS PET_ALLERGIES,
  PET_MEDICAL_CONDITION AS PET_MEDICAL_CONDITION,
  PET_MEDICATION_ALLERGIES AS PET_MEDICATION_ALLERGIES,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  LKP_SKU_PROFILE_24"""

df_25 = spark.sql(query_25)

df_25.createOrReplaceTempView("EXP_PRE_25")

# COMMAND ----------
# DBTITLE 1, Shortcut_to_OMS_ORDER_LN_PET_RX_ATTR_26


query_26 = f"""SELECT
  OMS_ORDER_ID AS OMS_ORDER_ID,
  OMS_ORDER_LN_ID AS OMS_ORDER_LN_ID,
  PRODUCT_ID AS PRODUCT_ID,
  RX_SKU AS RX_SKU,
  RX_STATUS AS RX_STATUS,
  RX_STATUS_UPDATE_TSTMP AS RX_STATUS_UPDATE_TSTMP,
  PET_NAME AS PET_NAME,
  OMS_PET_TYPE_ID AS OMS_PET_TYPE_ID,
  OMS_PET_BREED_ID AS OMS_PET_BREED_ID,
  PET_WEIGHT AS PET_WEIGHT,
  PET_BIRTH_DT AS PET_BIRTH_DT,
  PET_AGE AS PET_AGE,
  OMS_PET_GENDER_ID AS OMS_PET_GENDER_ID,
  PET_RX_NOTES AS PET_RX_NOTES,
  VET_NAME AS VET_NAME,
  CLINIC_NAME AS CLINIC_NAME,
  CLINIC_ADDR_1 AS CLINIC_ADDR_1,
  CLINIC_ADDR_2 AS CLINIC_ADDR_2,
  CLINIC_ADDR_3 AS CLINIC_ADDR_3,
  CLINIC_CITY AS CLINIC_CITY,
  CLINIC_STATE_PROV_CD AS CLINIC_STATE_PROV_CD,
  CLINIC_ZIP_POSTAL_CD AS CLINIC_ZIP_POSTAL_CD,
  CLINIC_COUNTRY_CD AS CLINIC_COUNTRY_CD,
  CLINIC_PHONE AS CLINIC_PHONE,
  CLINIC_FAX AS CLINIC_FAX,
  CLINIC_EMAIL AS CLINIC_EMAIL,
  CLINIC_CLINIC_HIN AS CLINIC_CLINIC_HIN,
  RX_CONTACT_VET_FLAG AS RX_CONTACT_VET_FLAG,
  PET_OWNER_NAME AS PET_OWNER_NAME,
  RX_TYPE AS RX_TYPE,
  PET_MEDICATIONS AS PET_MEDICATIONS,
  PET_ALLERGIES AS PET_ALLERGIES,
  PET_MEDICATION_ALLERGIES AS PET_MEDICATION_ALLERGIES,
  PET_MEDICAL_CONDITION AS PET_MEDICAL_CONDITION,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP
FROM
  OMS_ORDER_LN_PET_RX_ATTR"""

df_26 = spark.sql(query_26)

df_26.createOrReplaceTempView("Shortcut_to_OMS_ORDER_LN_PET_RX_ATTR_26")

# COMMAND ----------
# DBTITLE 1, SQ_Shortcut_to_OMS_ORDER_LN_PET_RX_ATTR_27


query_27 = f"""SELECT
  OMS_ORDER_ID AS OMS_ORDER_ID,
  OMS_ORDER_LN_ID AS OMS_ORDER_LN_ID,
  PRODUCT_ID AS PRODUCT_ID,
  RX_SKU AS RX_SKU,
  RX_STATUS AS RX_STATUS,
  RX_STATUS_UPDATE_TSTMP AS RX_STATUS_UPDATE_TSTMP,
  PET_NAME AS PET_NAME,
  OMS_PET_TYPE_ID AS OMS_PET_TYPE_ID,
  OMS_PET_BREED_ID AS OMS_PET_BREED_ID,
  PET_WEIGHT AS PET_WEIGHT,
  PET_BIRTH_DT AS PET_BIRTH_DT,
  PET_AGE AS PET_AGE,
  OMS_PET_GENDER_ID AS OMS_PET_GENDER_ID,
  PET_RX_NOTES AS PET_RX_NOTES,
  VET_NAME AS VET_NAME,
  CLINIC_NAME AS CLINIC_NAME,
  CLINIC_ADDR_1 AS CLINIC_ADDR_1,
  CLINIC_ADDR_2 AS CLINIC_ADDR_2,
  CLINIC_ADDR_3 AS CLINIC_ADDR_3,
  CLINIC_CITY AS CLINIC_CITY,
  CLINIC_STATE_PROV_CD AS CLINIC_STATE_PROV_CD,
  CLINIC_ZIP_POSTAL_CD AS CLINIC_ZIP_POSTAL_CD,
  CLINIC_COUNTRY_CD AS CLINIC_COUNTRY_CD,
  CLINIC_PHONE AS CLINIC_PHONE,
  CLINIC_FAX AS CLINIC_FAX,
  CLINIC_EMAIL AS CLINIC_EMAIL,
  CLINIC_CLINIC_HIN AS CLINIC_CLINIC_HIN,
  RX_CONTACT_VET_FLAG AS RX_CONTACT_VET_FLAG,
  PET_OWNER_NAME AS PET_OWNER_NAME,
  RX_TYPE AS RX_TYPE,
  PET_MEDICATIONS AS PET_MEDICATIONS,
  PET_ALLERGIES AS PET_ALLERGIES,
  PET_MEDICATION_ALLERGIES AS PET_MEDICATION_ALLERGIES,
  PET_MEDICAL_CONDITION AS PET_MEDICAL_CONDITION,
  UPDATE_TSTMP AS UPDATE_TSTMP,
  LOAD_TSTMP AS LOAD_TSTMP,
  monotonically_increasing_id() AS Monotonically_Increasing_Id
FROM
  Shortcut_to_OMS_ORDER_LN_PET_RX_ATTR_26"""

df_27 = spark.sql(query_27)

df_27.createOrReplaceTempView("SQ_Shortcut_to_OMS_ORDER_LN_PET_RX_ATTR_27")

# COMMAND ----------
# DBTITLE 1, JNR_OMS_ORDER_LN_PET_RX_ATTR_28


query_28 = f"""SELECT
  DETAIL.o_OMS_ORDER_ID AS src_OMS_ORDER_ID,
  DETAIL.o_OMS_ORDER_LINE_ID AS src_OMS_ORDER_LINE_ID,
  DETAIL.PRODUCT_ID AS src_PRODUCT_ID,
  DETAIL.RX_SKU AS src_RX_SKU,
  DETAIL.RX_STATUS AS src_RX_STATUS,
  DETAIL.PET_NAME AS src_PET_NAME,
  DETAIL.o_OMS_PET_TYPE_ID AS src_OMS_PET_TYPE_ID,
  DETAIL.o_OMS_PET_BREED_ID AS src_OMS_PET_BREED_ID,
  DETAIL.o_PET_WEIGHT AS src_PET_WEIGHT,
  DETAIL.o_PET_BIRTH_DT AS src_PET_BIRTH_DT,
  DETAIL.o_PET_AGE AS src_PET_AGE,
  DETAIL.o_OMS_PET_GENDER_ID AS src_OMS_PET_GENDER_ID,
  DETAIL.PET_RX_NOTES AS src_PET_RX_NOTES,
  DETAIL.VET_NAME AS src_VET_NAME,
  DETAIL.CLINIC_NAME AS src_CLINIC_NAME,
  DETAIL.CLINIC_ADDRESS_1 AS src_CLINIC_ADDRESS_1,
  DETAIL.CLINIC_CITY AS src_CLINIC_CITY,
  DETAIL.CLINIC_STATE_PROV_CD AS src_CLINIC_STATE_PROV_CD,
  DETAIL.CLINIC_PHONE AS src_CLINIC_PHONE,
  DETAIL.CLINIC_EMAIL AS src_CLINIC_EMAIL,
  DETAIL.CLINIC_FAX AS src_CLINIC_FAX,
  DETAIL.o_CLINIC_CLINIC_HIN AS src_CLINIC_CLINIC_HIN,
  DETAIL.o_RX_CONTACT_VET_FLAG AS src_RX_CONTACT_VET_FLAG,
  DETAIL.PET_OWNER_NAME AS src_PET_OWNER_NAME,
  DETAIL.RX_TYPE AS src_RX_TYPE,
  DETAIL.PET_MEDICATIONS AS src_PET_MEDICATIONS,
  DETAIL.PET_ALLERGIES AS src_PET_ALLERGIES,
  DETAIL.PET_MEDICAL_CONDITION AS src_PET_MEDICAL_CONDITION,
  DETAIL.PET_MEDICATION_ALLERGIES AS src_PET_MEDICATION_ALLERGIES,
  MASTER.OMS_ORDER_ID AS lkp_OMS_ORDER_ID,
  MASTER.OMS_ORDER_LN_ID AS lkp_OMS_ORDER_LN_ID,
  MASTER.PRODUCT_ID AS lkp_PRODUCT_ID,
  MASTER.RX_SKU AS lkp_RX_SKU,
  MASTER.RX_STATUS AS lkp_RX_STATUS,
  MASTER.RX_STATUS_UPDATE_TSTMP AS lkp_RX_STATUS_UPDATE_TSTMP,
  MASTER.PET_NAME AS lkp_PET_NAME,
  MASTER.OMS_PET_TYPE_ID AS lkp_OMS_PET_TYPE_ID,
  MASTER.OMS_PET_BREED_ID AS lkp_OMS_PET_BREED_ID,
  MASTER.PET_WEIGHT AS lkp_PET_WEIGHT,
  MASTER.PET_BIRTH_DT AS lkp_PET_BIRTH_DT,
  MASTER.PET_AGE AS lkp_PET_AGE,
  MASTER.OMS_PET_GENDER_ID AS lkp_OMS_PET_GENDER_ID,
  MASTER.PET_RX_NOTES AS lkp_PET_RX_NOTES,
  MASTER.VET_NAME AS lkp_VET_NAME,
  MASTER.CLINIC_NAME AS lkp_CLINIC_NAME,
  MASTER.CLINIC_ADDR_1 AS lkp_CLINIC_ADDR_1,
  MASTER.CLINIC_ADDR_2 AS lkp_CLINIC_ADDR_2,
  MASTER.CLINIC_ADDR_3 AS lkp_CLINIC_ADDR_3,
  MASTER.CLINIC_CITY AS lkp_CLINIC_CITY,
  MASTER.CLINIC_STATE_PROV_CD AS lkp_CLINIC_STATE_PROV_CD,
  MASTER.CLINIC_ZIP_POSTAL_CD AS lkp_CLINIC_ZIP_POSTAL_CD,
  MASTER.CLINIC_COUNTRY_CD AS lkp_CLINIC_COUNTRY_CD,
  MASTER.CLINIC_PHONE AS lkp_CLINIC_PHONE,
  MASTER.CLINIC_FAX AS lkp_CLINIC_FAX,
  MASTER.CLINIC_EMAIL AS lkp_CLINIC_EMAIL,
  MASTER.CLINIC_CLINIC_HIN AS lkp_CLINIC_CLINIC_HIN,
  MASTER.RX_CONTACT_VET_FLAG AS lkp_RX_CONTACT_VET_FLAG,
  MASTER.PET_OWNER_NAME AS lkp_PET_OWNER_NAME,
  MASTER.RX_TYPE AS lkp_RX_TYPE,
  MASTER.PET_MEDICATIONS AS lkp_PET_MEDICATIONS,
  MASTER.PET_ALLERGIES AS lkp_PET_ALLERGIES,
  MASTER.PET_MEDICATION_ALLERGIES AS lkp_PET_MEDICATION_ALLERGIES,
  MASTER.PET_MEDICAL_CONDITION AS lkp_PET_MEDICAL_CONDITION,
  MASTER.UPDATE_TSTMP AS lkp_UPDATE_TSTMP,
  MASTER.LOAD_TSTMP AS lkp_LOAD_TSTMP,
  DETAIL.Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  SQ_Shortcut_to_OMS_ORDER_LN_PET_RX_ATTR_27 MASTER
  RIGHT JOIN EXP_PRE_25 DETAIL ON MASTER.OMS_ORDER_ID = DETAIL.o_OMS_ORDER_ID
  AND MASTER.OMS_ORDER_LN_ID = DETAIL.o_OMS_ORDER_LINE_ID"""

df_28 = spark.sql(query_28)

df_28.createOrReplaceTempView("JNR_OMS_ORDER_LN_PET_RX_ATTR_28")

# COMMAND ----------
# DBTITLE 1, FIL_UNCHANGED_RECORDS_29


query_29 = f"""SELECT
  src_OMS_ORDER_ID AS src_OMS_ORDER_ID,
  src_OMS_ORDER_LINE_ID AS src_OMS_ORDER_LINE_ID,
  src_PRODUCT_ID AS src_PRODUCT_ID,
  src_RX_SKU AS src_RX_SKU,
  src_RX_STATUS AS src_RX_STATUS,
  src_PET_NAME AS src_PET_NAME,
  src_OMS_PET_TYPE_ID AS src_OMS_PET_TYPE_ID,
  src_OMS_PET_BREED_ID AS src_OMS_PET_BREED_ID,
  src_PET_WEIGHT AS src_PET_WEIGHT,
  src_PET_BIRTH_DT AS src_PET_BIRTH_DT,
  src_PET_AGE AS src_PET_AGE,
  src_OMS_PET_GENDER_ID AS src_OMS_PET_GENDER_ID,
  src_PET_RX_NOTES AS src_PET_RX_NOTES,
  src_VET_NAME AS src_VET_NAME,
  src_CLINIC_NAME AS src_CLINIC_NAME,
  src_CLINIC_ADDRESS_1 AS src_CLINIC_ADDRESS_1,
  src_CLINIC_CITY AS src_CLINIC_CITY,
  src_CLINIC_STATE_PROV_CD AS src_CLINIC_STATE_PROV_CD,
  src_CLINIC_PHONE AS src_CLINIC_PHONE,
  src_CLINIC_EMAIL AS src_CLINIC_EMAIL,
  src_CLINIC_FAX AS src_CLINIC_FAX,
  src_CLINIC_CLINIC_HIN AS src_CLINIC_CLINIC_HIN,
  src_RX_CONTACT_VET_FLAG AS src_RX_CONTACT_VET_FLAG,
  src_PET_OWNER_NAME AS src_PET_OWNER_NAME,
  src_RX_TYPE AS src_RX_TYPE,
  src_PET_MEDICATIONS AS src_PET_MEDICATIONS,
  src_PET_ALLERGIES AS src_PET_ALLERGIES,
  src_PET_MEDICAL_CONDITION AS src_PET_MEDICAL_CONDITION,
  src_PET_MEDICATION_ALLERGIES AS src_PET_MEDICATION_ALLERGIES,
  lkp_OMS_ORDER_ID AS lkp_OMS_ORDER_ID,
  lkp_OMS_ORDER_LN_ID AS lkp_OMS_ORDER_LN_ID,
  lkp_PRODUCT_ID AS lkp_PRODUCT_ID,
  lkp_RX_SKU AS lkp_RX_SKU,
  lkp_RX_STATUS AS lkp_RX_STATUS,
  lkp_RX_STATUS_UPDATE_TSTMP AS lkp_RX_STATUS_UPDATE_TSTMP,
  lkp_PET_NAME AS lkp_PET_NAME,
  lkp_OMS_PET_TYPE_ID AS lkp_OMS_PET_TYPE_ID,
  lkp_OMS_PET_BREED_ID AS lkp_OMS_PET_BREED_ID,
  lkp_PET_WEIGHT AS lkp_PET_WEIGHT,
  lkp_PET_BIRTH_DT AS lkp_PET_BIRTH_DT,
  lkp_PET_AGE AS lkp_PET_AGE,
  lkp_OMS_PET_GENDER_ID AS lkp_OMS_PET_GENDER_ID,
  lkp_PET_RX_NOTES AS lkp_PET_RX_NOTES,
  lkp_VET_NAME AS lkp_VET_NAME,
  lkp_CLINIC_NAME AS lkp_CLINIC_NAME,
  lkp_CLINIC_ADDR_1 AS lkp_CLINIC_ADDR_1,
  lkp_CLINIC_ADDR_2 AS lkp_CLINIC_ADDR_2,
  lkp_CLINIC_ADDR_3 AS lkp_CLINIC_ADDR_3,
  lkp_CLINIC_CITY AS lkp_CLINIC_CITY,
  lkp_CLINIC_STATE_PROV_CD AS lkp_CLINIC_STATE_PROV_CD,
  lkp_CLINIC_ZIP_POSTAL_CD AS lkp_CLINIC_ZIP_POSTAL_CD,
  lkp_CLINIC_COUNTRY_CD AS lkp_CLINIC_COUNTRY_CD,
  lkp_CLINIC_PHONE AS lkp_CLINIC_PHONE,
  lkp_CLINIC_FAX AS lkp_CLINIC_FAX,
  lkp_CLINIC_EMAIL AS lkp_CLINIC_EMAIL,
  lkp_CLINIC_CLINIC_HIN AS lkp_CLINIC_CLINIC_HIN,
  lkp_RX_CONTACT_VET_FLAG AS lkp_RX_CONTACT_VET_FLAG,
  lkp_PET_OWNER_NAME AS lkp_PET_OWNER_NAME,
  lkp_RX_TYPE AS lkp_RX_TYPE,
  lkp_PET_MEDICATIONS AS lkp_PET_MEDICATIONS,
  lkp_PET_ALLERGIES AS lkp_PET_ALLERGIES,
  lkp_PET_MEDICATION_ALLERGIES AS lkp_PET_MEDICATION_ALLERGIES,
  lkp_PET_MEDICAL_CONDITION AS lkp_PET_MEDICAL_CONDITION,
  lkp_UPDATE_TSTMP AS lkp_UPDATE_TSTMP,
  lkp_LOAD_TSTMP AS lkp_LOAD_TSTMP,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  JNR_OMS_ORDER_LN_PET_RX_ATTR_28
WHERE
  ISNULL(lkp_OMS_ORDER_LN_ID)
  OR (
    NOT ISNULL(lkp_OMS_ORDER_LN_ID)
    AND (
      src_PRODUCT_ID <> lkp_PRODUCT_ID
      OR src_RX_SKU <> lkp_RX_SKU
      OR src_RX_STATUS <> lkp_RX_STATUS
      OR src_PET_NAME <> lkp_PET_NAME
      OR src_OMS_PET_TYPE_ID <> lkp_OMS_PET_TYPE_ID
      OR src_OMS_PET_BREED_ID <> lkp_OMS_PET_BREED_ID
      OR src_PET_WEIGHT <> lkp_PET_WEIGHT
      OR src_PET_BIRTH_DT <> lkp_PET_BIRTH_DT
      OR src_PET_AGE <> lkp_PET_AGE
      OR src_OMS_PET_GENDER_ID <> lkp_OMS_PET_GENDER_ID
      OR src_PET_RX_NOTES <> lkp_PET_RX_NOTES
      OR src_VET_NAME <> lkp_VET_NAME
      OR src_CLINIC_NAME <> lkp_CLINIC_NAME
      OR src_CLINIC_ADDRESS_1 <> lkp_CLINIC_ADDR_1
      OR src_CLINIC_CITY <> lkp_CLINIC_CITY
      OR src_CLINIC_STATE_PROV_CD <> lkp_CLINIC_STATE_PROV_CD
      OR src_CLINIC_PHONE <> lkp_CLINIC_PHONE
      OR src_CLINIC_EMAIL <> lkp_CLINIC_EMAIL
      OR src_CLINIC_FAX <> lkp_CLINIC_FAX
      OR src_CLINIC_CLINIC_HIN <> lkp_CLINIC_CLINIC_HIN
      OR src_RX_CONTACT_VET_FLAG <> lkp_RX_CONTACT_VET_FLAG
      OR src_PET_OWNER_NAME <> lkp_PET_OWNER_NAME
      OR src_RX_TYPE <> lkp_RX_TYPE
      OR src_PET_MEDICATIONS <> lkp_PET_MEDICATIONS
      OR src_PET_ALLERGIES <> lkp_PET_ALLERGIES
      OR src_PET_MEDICAL_CONDITION <> lkp_PET_MEDICAL_CONDITION
      OR src_PET_MEDICATION_ALLERGIES <> lkp_PET_MEDICATION_ALLERGIES
    )
  )"""

df_29 = spark.sql(query_29)

df_29.createOrReplaceTempView("FIL_UNCHANGED_RECORDS_29")

# COMMAND ----------
# DBTITLE 1, EXP_UPDATE_FLAG_30


query_30 = f"""SELECT
  src_OMS_ORDER_ID AS src_OMS_ORDER_ID,
  src_OMS_ORDER_LINE_ID AS src_OMS_ORDER_LINE_ID,
  src_PRODUCT_ID AS src_PRODUCT_ID,
  src_RX_SKU AS src_RX_SKU,
  src_RX_STATUS AS src_RX_STATUS,
  IFF(
    (
      LTRIM(RTRIM(src_RX_STATUS)) = 'rx_food_approved'
      or LTRIM(RTRIM(src_RX_STATUS)) = 'rx_med_denied'
      or LTRIM(RTRIM(src_RX_STATUS)) = 'rx_med_approved'
      or LTRIM(RTRIM(src_RX_STATUS)) = 'rx_not_req_approved'
      or LTRIM(RTRIM(src_RX_STATUS)) = 'rx_not_req_denied'
      or LTRIM(RTRIM(src_RX_STATUS)) = 'rx_food_denied'
    ),
    IFF(
      LTRIM(RTRIM(lkp_RX_STATUS)) = 'rx_food_approved'
      or LTRIM(RTRIM(lkp_RX_STATUS)) = 'rx_med_denied'
      or LTRIM(RTRIM(lkp_RX_STATUS)) = 'rx_med_approved'
      or LTRIM(RTRIM(lkp_RX_STATUS)) = 'rx_not_req_approved'
      or LTRIM(RTRIM(lkp_RX_STATUS)) = 'rx_not_req_denied'
      or LTRIM(RTRIM(lkp_RX_STATUS)) = 'rx_food_denied',
      lkp_RX_STATUS_UPDATE_TSTMP,
      now()
    )
  ) AS o_RX_STATUS_UPDATE_TSTMP,
  src_PET_NAME AS src_PET_NAME,
  src_OMS_PET_TYPE_ID AS src_OMS_PET_TYPE_ID,
  src_OMS_PET_BREED_ID AS src_OMS_PET_BREED_ID,
  src_PET_WEIGHT AS src_PET_WEIGHT,
  src_PET_BIRTH_DT AS src_PET_BIRTH_DT,
  src_PET_AGE AS src_PET_AGE,
  src_OMS_PET_GENDER_ID AS src_OMS_PET_GENDER_ID,
  src_PET_RX_NOTES AS src_PET_RX_NOTES,
  src_VET_NAME AS src_VET_NAME,
  src_CLINIC_NAME AS src_CLINIC_NAME,
  src_CLINIC_ADDRESS_1 AS src_CLINIC_ADDRESS_1,
  src_CLINIC_CITY AS src_CLINIC_CITY,
  src_CLINIC_STATE_PROV_CD AS src_CLINIC_STATE_PROV_CD,
  src_CLINIC_PHONE AS src_CLINIC_PHONE,
  src_CLINIC_EMAIL AS src_CLINIC_EMAIL,
  src_CLINIC_FAX AS src_CLINIC_FAX,
  src_CLINIC_CLINIC_HIN AS src_CLINIC_CLINIC_HIN,
  src_RX_CONTACT_VET_FLAG AS src_RX_CONTACT_VET_FLAG,
  src_PET_OWNER_NAME AS src_PET_OWNER_NAME,
  src_RX_TYPE AS src_RX_TYPE,
  src_PET_MEDICATIONS AS src_PET_MEDICATIONS,
  src_PET_ALLERGIES AS src_PET_ALLERGIES,
  src_PET_MEDICAL_CONDITION AS src_PET_MEDICAL_CONDITION,
  src_PET_MEDICATION_ALLERGIES AS src_PET_MEDICATION_ALLERGIES,
  lkp_OMS_ORDER_ID AS lkp_OMS_ORDER_ID,
  lkp_OMS_ORDER_LN_ID AS lkp_OMS_ORDER_LN_ID,
  lkp_PRODUCT_ID AS lkp_PRODUCT_ID,
  lkp_RX_SKU AS lkp_RX_SKU,
  lkp_RX_STATUS AS lkp_RX_STATUS,
  lkp_RX_STATUS_UPDATE_TSTMP AS lkp_RX_STATUS_UPDATE_TSTMP,
  lkp_PET_NAME AS lkp_PET_NAME,
  lkp_OMS_PET_TYPE_ID AS lkp_OMS_PET_TYPE_ID,
  lkp_OMS_PET_BREED_ID AS lkp_OMS_PET_BREED_ID,
  lkp_PET_WEIGHT AS lkp_PET_WEIGHT,
  lkp_PET_BIRTH_DT AS lkp_PET_BIRTH_DT,
  lkp_PET_AGE AS lkp_PET_AGE,
  lkp_OMS_PET_GENDER_ID AS lkp_OMS_PET_GENDER_ID,
  lkp_PET_RX_NOTES AS lkp_PET_RX_NOTES,
  lkp_VET_NAME AS lkp_VET_NAME,
  lkp_CLINIC_NAME AS lkp_CLINIC_NAME,
  lkp_CLINIC_ADDR_1 AS lkp_CLINIC_ADDR_1,
  lkp_CLINIC_ADDR_2 AS lkp_CLINIC_ADDR_2,
  lkp_CLINIC_ADDR_3 AS lkp_CLINIC_ADDR_3,
  lkp_CLINIC_CITY AS lkp_CLINIC_CITY,
  lkp_CLINIC_STATE_PROV_CD AS lkp_CLINIC_STATE_PROV_CD,
  lkp_CLINIC_ZIP_POSTAL_CD AS lkp_CLINIC_ZIP_POSTAL_CD,
  lkp_CLINIC_COUNTRY_CD AS lkp_CLINIC_COUNTRY_CD,
  lkp_CLINIC_PHONE AS lkp_CLINIC_PHONE,
  lkp_CLINIC_FAX AS lkp_CLINIC_FAX,
  lkp_CLINIC_EMAIL AS lkp_CLINIC_EMAIL,
  lkp_CLINIC_CLINIC_HIN AS lkp_CLINIC_CLINIC_HIN,
  lkp_RX_CONTACT_VET_FLAG AS lkp_RX_CONTACT_VET_FLAG,
  lkp_PET_OWNER_NAME AS lkp_PET_OWNER_NAME,
  lkp_RX_TYPE AS lkp_RX_TYPE,
  lkp_PET_MEDICATIONS AS lkp_PET_MEDICATIONS,
  lkp_PET_ALLERGIES AS lkp_PET_ALLERGIES,
  lkp_PET_MEDICATION_ALLERGIES AS lkp_PET_MEDICATION_ALLERGIES,
  lkp_PET_MEDICAL_CONDITION AS lkp_PET_MEDICAL_CONDITION,
  lkp_UPDATE_TSTMP AS lkp_UPDATE_TSTMP,
  lkp_LOAD_TSTMP AS lkp_LOAD_TSTMP,
  now() AS o_UPDATE_TSTMP,
  IFF(ISNULL(lkp_LOAD_TSTMP), now(), lkp_LOAD_TSTMP) AS o_LOAD_TSTMP,
  IFF(ISNULL(lkp_OMS_ORDER_LN_ID), 1, 2) AS o_UPDATE_FLAG,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  FIL_UNCHANGED_RECORDS_29"""

df_30 = spark.sql(query_30)

df_30.createOrReplaceTempView("EXP_UPDATE_FLAG_30")

# COMMAND ----------
# DBTITLE 1, exp_retrieve_PET_ATTRIBUTES_31


query_31 = f"""SELECT
  LKP_PET_TYPE(src_OMS_PET_TYPE_ID) AS OMS_PET_TYPE_DESC,
  LKP_PET_BREED(src_OMS_PET_BREED_ID) AS OMS_PET_BREED_DESC,
  LKP_PET_GENDER(src_OMS_PET_GENDER_ID) AS OMS_PET_GENDER_DESC,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  EXP_UPDATE_FLAG_30"""

df_31 = spark.sql(query_31)

df_31.createOrReplaceTempView("exp_retrieve_PET_ATTRIBUTES_31")

# COMMAND ----------
# DBTITLE 1, exp_retrieve_PET_MEDICATIONS_32


query_32 = f"""SELECT
  instr(src_PET_MEDICATIONS, '|', 1, 1) AS v_PET_MEDICATIONS_PART1_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 2) AS v_PET_MEDICATIONS_PART2_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 3) AS v_PET_MEDICATIONS_PART3_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 4) AS v_PET_MEDICATIONS_PART4_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 5) AS v_PET_MEDICATIONS_PART5_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 6) AS v_PET_MEDICATIONS_PART6_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 7) AS v_PET_MEDICATIONS_PART7_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 8) AS v_PET_MEDICATIONS_PART8_ENDPOS,
  instr(src_PET_MEDICATIONS, '|', 1, 9) AS v_PET_MEDICATIONS_PART9_ENDPOS,
  IFF(
    v_PET_MEDICATIONS_PART1_ENDPOS = 0,
    src_PET_MEDICATIONS,
    substr(
      src_PET_MEDICATIONS,
      1,
      v_PET_MEDICATIONS_PART1_ENDPOS -1
    )
  ) AS v_PET_MEDICATIONS_PART1,
  IFF(
    v_PET_MEDICATIONS_PART2_ENDPOS = 0
    and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART1_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART1_ENDPOS + 1,
      v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART2,
  IFF(
    v_PET_MEDICATIONS_PART3_ENDPOS = 0
    and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART2_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART2_ENDPOS + 1,
      v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART3,
  IFF(
    v_PET_MEDICATIONS_PART4_ENDPOS = 0
    and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART3_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART3_ENDPOS + 1,
      v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART4,
  IFF(
    v_PET_MEDICATIONS_PART5_ENDPOS = 0
    and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART4_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART4_ENDPOS + 1,
      v_PET_MEDICATIONS_PART5_ENDPOS - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART5,
  IFF(
    v_PET_MEDICATIONS_PART6_ENDPOS = 0
    and v_PET_MEDICATIONS_PART5_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART5_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART5_ENDPOS + 1,
      v_PET_MEDICATIONS_PART6_ENDPOS - (v_PET_MEDICATIONS_PART5_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART6,
  IFF(
    v_PET_MEDICATIONS_PART7_ENDPOS = 0
    and v_PET_MEDICATIONS_PART6_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART6_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART6_ENDPOS + 1,
      v_PET_MEDICATIONS_PART7_ENDPOS - (v_PET_MEDICATIONS_PART6_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART7,
  IFF(
    v_PET_MEDICATIONS_PART8_ENDPOS = 0
    and v_PET_MEDICATIONS_PART7_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART7_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART7_ENDPOS + 1,
      v_PET_MEDICATIONS_PART8_ENDPOS - (v_PET_MEDICATIONS_PART7_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART8,
  IFF(
    v_PET_MEDICATIONS_PART9_ENDPOS = 0
    and v_PET_MEDICATIONS_PART8_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART8_ENDPOS + 1
    ),
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART8_ENDPOS + 1,
      v_PET_MEDICATIONS_PART9_ENDPOS - (v_PET_MEDICATIONS_PART8_ENDPOS + 1)
    )
  ) AS v_PET_MEDICATIONS_PART9,
  IFF(
    v_PET_MEDICATIONS_PART9_ENDPOS != 0,
    substr(
      src_PET_MEDICATIONS,
      v_PET_MEDICATIONS_PART9_ENDPOS + 1
    ),
    NULL
  ) AS v_PET_MEDICATIONS_PART10,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART1),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART1),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART1)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART1_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART2),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART2),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART2)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART2_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART3),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART3),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART3)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART3_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART4),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART4),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART4)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART4_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART5),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART5),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART5)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART5_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART6),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART6),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART6)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART6_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART7),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART7),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART7)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART7_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART8),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART8),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART8)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART8_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART9),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART9),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART9)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART9_LKP,
  IFF(
    ISNULL(v_PET_MEDICATIONS_PART10),
    NULL,
    IFF(
      IS_NUMBER(v_PET_MEDICATIONS_PART10),
      LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART10)),
      NULL
    )
  ) AS v_PET_MEDICATIONS_PART10_LKP,
  rtrim(
    (
      IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART1_ENDPOS = 0,
            src_PET_MEDICATIONS,
            substr(
              src_PET_MEDICATIONS,
              1,
              v_PET_MEDICATIONS_PART1_ENDPOS -1
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_MEDICATIONS_PART1_ENDPOS = 0,
                  src_PET_MEDICATIONS,
                  substr(
                    src_PET_MEDICATIONS,
                    1,
                    v_PET_MEDICATIONS_PART1_ENDPOS -1
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_MEDICATIONS_PART1_ENDPOS = 0,
                    src_PET_MEDICATIONS,
                    substr(
                      src_PET_MEDICATIONS,
                      1,
                      v_PET_MEDICATIONS_PART1_ENDPOS -1
                    )
                  )
                ),
                LKP_PET_MEDICATION(
                  TO_INTEGER(
                    IFF(
                      v_PET_MEDICATIONS_PART1_ENDPOS = 0,
                      src_PET_MEDICATIONS,
                      substr(
                        src_PET_MEDICATIONS,
                        1,
                        v_PET_MEDICATIONS_PART1_ENDPOS -1
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART1_ENDPOS = 0,
            src_PET_MEDICATIONS,
            substr(
              src_PET_MEDICATIONS,
              1,
              v_PET_MEDICATIONS_PART1_ENDPOS -1
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_MEDICATIONS_PART1_ENDPOS = 0,
                src_PET_MEDICATIONS,
                substr(
                  src_PET_MEDICATIONS,
                  1,
                  v_PET_MEDICATIONS_PART1_ENDPOS -1
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_MEDICATIONS_PART1_ENDPOS = 0,
                  src_PET_MEDICATIONS,
                  substr(
                    src_PET_MEDICATIONS,
                    1,
                    v_PET_MEDICATIONS_PART1_ENDPOS -1
                  )
                )
              ),
              LKP_PET_MEDICATION(
                TO_INTEGER(
                  IFF(
                    v_PET_MEDICATIONS_PART1_ENDPOS = 0,
                    src_PET_MEDICATIONS,
                    substr(
                      src_PET_MEDICATIONS,
                      1,
                      v_PET_MEDICATIONS_PART1_ENDPOS -1
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART2_ENDPOS = 0
            and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART1_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART1_ENDPOS + 1,
              v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_MEDICATIONS_PART2_ENDPOS = 0
                  and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART1_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART1_ENDPOS + 1,
                    v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_MEDICATIONS_PART2_ENDPOS = 0
                    and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART1_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART1_ENDPOS + 1,
                      v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
                    )
                  )
                ),
                LKP_PET_MEDICATION(
                  TO_INTEGER(
                    IFF(
                      v_PET_MEDICATIONS_PART2_ENDPOS = 0
                      and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART1_ENDPOS + 1
                      ),
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART1_ENDPOS + 1,
                        v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART2_ENDPOS = 0
            and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART1_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART1_ENDPOS + 1,
              v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_MEDICATIONS_PART2_ENDPOS = 0
                and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART1_ENDPOS + 1
                ),
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART1_ENDPOS + 1,
                  v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_MEDICATIONS_PART2_ENDPOS = 0
                  and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART1_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART1_ENDPOS + 1,
                    v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
                  )
                )
              ),
              LKP_PET_MEDICATION(
                TO_INTEGER(
                  IFF(
                    v_PET_MEDICATIONS_PART2_ENDPOS = 0
                    and v_PET_MEDICATIONS_PART1_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART1_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART1_ENDPOS + 1,
                      v_PET_MEDICATIONS_PART2_ENDPOS - (v_PET_MEDICATIONS_PART1_ENDPOS + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART3_ENDPOS = 0
            and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART2_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART2_ENDPOS + 1,
              v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_MEDICATIONS_PART3_ENDPOS = 0
                  and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART2_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART2_ENDPOS + 1,
                    v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_MEDICATIONS_PART3_ENDPOS = 0
                    and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART2_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART2_ENDPOS + 1,
                      v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
                    )
                  )
                ),
                LKP_PET_MEDICATION(
                  TO_INTEGER(
                    IFF(
                      v_PET_MEDICATIONS_PART3_ENDPOS = 0
                      and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART2_ENDPOS + 1
                      ),
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART2_ENDPOS + 1,
                        v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART3_ENDPOS = 0
            and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART2_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART2_ENDPOS + 1,
              v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_MEDICATIONS_PART3_ENDPOS = 0
                and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART2_ENDPOS + 1
                ),
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART2_ENDPOS + 1,
                  v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_MEDICATIONS_PART3_ENDPOS = 0
                  and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART2_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART2_ENDPOS + 1,
                    v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
                  )
                )
              ),
              LKP_PET_MEDICATION(
                TO_INTEGER(
                  IFF(
                    v_PET_MEDICATIONS_PART3_ENDPOS = 0
                    and v_PET_MEDICATIONS_PART2_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART2_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART2_ENDPOS + 1,
                      v_PET_MEDICATIONS_PART3_ENDPOS - (v_PET_MEDICATIONS_PART2_ENDPOS + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART4_ENDPOS = 0
            and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART3_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART3_ENDPOS + 1,
              v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_MEDICATIONS_PART4_ENDPOS = 0
                  and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART3_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART3_ENDPOS + 1,
                    v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_MEDICATIONS_PART4_ENDPOS = 0
                    and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART3_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART3_ENDPOS + 1,
                      v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
                    )
                  )
                ),
                LKP_PET_MEDICATION(
                  TO_INTEGER(
                    IFF(
                      v_PET_MEDICATIONS_PART4_ENDPOS = 0
                      and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART3_ENDPOS + 1
                      ),
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART3_ENDPOS + 1,
                        v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART4_ENDPOS = 0
            and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART3_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART3_ENDPOS + 1,
              v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_MEDICATIONS_PART4_ENDPOS = 0
                and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART3_ENDPOS + 1
                ),
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART3_ENDPOS + 1,
                  v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_MEDICATIONS_PART4_ENDPOS = 0
                  and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART3_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART3_ENDPOS + 1,
                    v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
                  )
                )
              ),
              LKP_PET_MEDICATION(
                TO_INTEGER(
                  IFF(
                    v_PET_MEDICATIONS_PART4_ENDPOS = 0
                    and v_PET_MEDICATIONS_PART3_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART3_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART3_ENDPOS + 1,
                      v_PET_MEDICATIONS_PART4_ENDPOS - (v_PET_MEDICATIONS_PART3_ENDPOS + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
            and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART4_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART4_ENDPOS + 1,
              instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
                  and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART4_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART4_ENDPOS + 1,
                    instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
                    and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART4_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART4_ENDPOS + 1,
                      instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
                    )
                  )
                ),
                LKP_PET_MEDICATION(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
                      and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART4_ENDPOS + 1
                      ),
                      substr(
                        src_PET_MEDICATIONS,
                        v_PET_MEDICATIONS_PART4_ENDPOS + 1,
                        instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
            and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART4_ENDPOS + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART4_ENDPOS + 1,
              instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
                and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART4_ENDPOS + 1
                ),
                substr(
                  src_PET_MEDICATIONS,
                  v_PET_MEDICATIONS_PART4_ENDPOS + 1,
                  instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
                  and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART4_ENDPOS + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    v_PET_MEDICATIONS_PART4_ENDPOS + 1,
                    instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
                  )
                )
              ),
              LKP_PET_MEDICATION(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATIONS, '|', 1, 5) = 0
                    and v_PET_MEDICATIONS_PART4_ENDPOS != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART4_ENDPOS + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      v_PET_MEDICATIONS_PART4_ENDPOS + 1,
                      instr(src_PET_MEDICATIONS, '|', 1, 5) - (v_PET_MEDICATIONS_PART4_ENDPOS + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART6_ENDPOS = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
              v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_MEDICATIONS_PART6_ENDPOS = 0
                  and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
                    v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_MEDICATIONS_PART6_ENDPOS = 0
                    and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
                      v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
                    )
                  )
                ),
                LKP_PET_MEDICATION(
                  TO_INTEGER(
                    IFF(
                      v_PET_MEDICATIONS_PART6_ENDPOS = 0
                      and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
                      substr(
                        src_PET_MEDICATIONS,
                        instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
                      ),
                      substr(
                        src_PET_MEDICATIONS,
                        instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
                        v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART6_ENDPOS = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
              v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_MEDICATIONS_PART6_ENDPOS = 0
                and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
                substr(
                  src_PET_MEDICATIONS,
                  instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
                ),
                substr(
                  src_PET_MEDICATIONS,
                  instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
                  v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_MEDICATIONS_PART6_ENDPOS = 0
                  and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
                  substr(
                    src_PET_MEDICATIONS,
                    instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_MEDICATIONS,
                    instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
                    v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
                  )
                )
              ),
              LKP_PET_MEDICATION(
                TO_INTEGER(
                  IFF(
                    v_PET_MEDICATIONS_PART6_ENDPOS = 0
                    and instr(src_PET_MEDICATIONS, '|', 1, 5) != 0,
                    substr(
                      src_PET_MEDICATIONS,
                      instr(src_PET_MEDICATIONS, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_MEDICATIONS,
                      instr(src_PET_MEDICATIONS, '|', 1, 5) + 1,
                      v_PET_MEDICATIONS_PART6_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 5) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART7_ENDPOS = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 6) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 6) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 6) + 1,
              v_PET_MEDICATIONS_PART7_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 6) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_MEDICATIONS_PART7),
              NULL,
              IFF(
                IS_NUMBER(v_PET_MEDICATIONS_PART7),
                LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART7)),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART7_ENDPOS = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 6) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 6) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 6) + 1,
              v_PET_MEDICATIONS_PART7_ENDPOS - (instr(src_PET_MEDICATIONS, '|', 1, 6) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_PET_MEDICATIONS_PART7),
            NULL,
            IFF(
              IS_NUMBER(v_PET_MEDICATIONS_PART7),
              LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART7)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATIONS, '|', 1, 8) = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 7) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 7) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 7) + 1,
              instr(src_PET_MEDICATIONS, '|', 1, 8) - (instr(src_PET_MEDICATIONS, '|', 1, 7) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_MEDICATIONS_PART8),
              NULL,
              IFF(
                IS_NUMBER(v_PET_MEDICATIONS_PART8),
                LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART8)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATIONS, '|', 1, 8) = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 7) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 7) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 7) + 1,
              instr(src_PET_MEDICATIONS, '|', 1, 8) - (instr(src_PET_MEDICATIONS, '|', 1, 7) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_PET_MEDICATIONS_PART8),
            NULL,
            IFF(
              IS_NUMBER(v_PET_MEDICATIONS_PART8),
              LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART8)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATIONS, '|', 1, 9) = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 8) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 8) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 8) + 1,
              instr(src_PET_MEDICATIONS, '|', 1, 9) - (instr(src_PET_MEDICATIONS, '|', 1, 8) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_MEDICATIONS_PART9),
              NULL,
              IFF(
                IS_NUMBER(v_PET_MEDICATIONS_PART9),
                LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART9)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATIONS, '|', 1, 9) = 0
            and instr(src_PET_MEDICATIONS, '|', 1, 8) != 0,
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 8) + 1
            ),
            substr(
              src_PET_MEDICATIONS,
              instr(src_PET_MEDICATIONS, '|', 1, 8) + 1,
              instr(src_PET_MEDICATIONS, '|', 1, 9) - (instr(src_PET_MEDICATIONS, '|', 1, 8) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_PET_MEDICATIONS_PART9),
            NULL,
            IFF(
              IS_NUMBER(v_PET_MEDICATIONS_PART9),
              LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART9)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_MEDICATIONS_PART9_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART9_ENDPOS + 1
            ),
            NULL
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_MEDICATIONS_PART10),
              NULL,
              IFF(
                IS_NUMBER(v_PET_MEDICATIONS_PART10),
                LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART10)),
                NULL
              )
            )
          ),
          IFF(
            v_PET_MEDICATIONS_PART9_ENDPOS != 0,
            substr(
              src_PET_MEDICATIONS,
              v_PET_MEDICATIONS_PART9_ENDPOS + 1
            ),
            NULL
          ) || '|',
          IFF(
            ISNULL(v_PET_MEDICATIONS_PART10),
            NULL,
            IFF(
              IS_NUMBER(v_PET_MEDICATIONS_PART10),
              LKP_PET_MEDICATION(TO_INTEGER(v_PET_MEDICATIONS_PART10)),
              NULL
            )
          ) || '|'
        )
      )
    ),
    ' |'
  ) AS PET_MEDICATIONS_DESC,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  EXP_UPDATE_FLAG_30"""

df_32 = spark.sql(query_32)

df_32.createOrReplaceTempView("exp_retrieve_PET_MEDICATIONS_32")

# COMMAND ----------
# DBTITLE 1, exp_retrieve_LKP_PET_CONDITION_33


query_33 = f"""SELECT
  instr(src_LKP_PET_CONDITION, '|', 1, 1) AS v_LKP_PET_CONDITION_PART1_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 2) AS v_LKP_PET_CONDITION_PART2_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 3) AS v_LKP_PET_CONDITION_PART3_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 4) AS v_LKP_PET_CONDITION_PART4_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 5) AS v_LKP_PET_CONDITION_PART5_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 6) AS v_LKP_PET_CONDITION_PART6_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 7) AS v_LKP_PET_CONDITION_PART7_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 8) AS v_LKP_PET_CONDITION_PART8_ENDPOS,
  instr(src_LKP_PET_CONDITION, '|', 1, 9) AS v_LKP_PET_CONDITION_PART9_ENDPOS,
  IFF(
    v_LKP_PET_CONDITION_PART1_ENDPOS = 0,
    src_LKP_PET_CONDITION,
    substr(
      src_LKP_PET_CONDITION,
      1,
      v_LKP_PET_CONDITION_PART1_ENDPOS -1
    )
  ) AS v_LKP_PET_CONDITION_PART1,
  IFF(
    v_LKP_PET_CONDITION_PART2_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART1_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART1_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART1_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART2_ENDPOS - (v_LKP_PET_CONDITION_PART1_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART2,
  IFF(
    v_LKP_PET_CONDITION_PART3_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART2_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART2_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART2_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART3_ENDPOS - (v_LKP_PET_CONDITION_PART2_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART3,
  IFF(
    v_LKP_PET_CONDITION_PART4_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART3_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART3_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART3_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART4_ENDPOS - (v_LKP_PET_CONDITION_PART3_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART4,
  IFF(
    v_LKP_PET_CONDITION_PART5_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART4_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART4_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART4_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART5_ENDPOS - (v_LKP_PET_CONDITION_PART4_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART5,
  IFF(
    v_LKP_PET_CONDITION_PART6_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART5_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART5_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART5_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART6_ENDPOS - (v_LKP_PET_CONDITION_PART5_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART6,
  IFF(
    v_LKP_PET_CONDITION_PART7_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART6_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART6_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART6_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART7_ENDPOS - (v_LKP_PET_CONDITION_PART6_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART7,
  IFF(
    v_LKP_PET_CONDITION_PART8_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART7_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART7_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART7_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART8_ENDPOS - (v_LKP_PET_CONDITION_PART7_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART8,
  IFF(
    v_LKP_PET_CONDITION_PART9_ENDPOS = 0
    and v_LKP_PET_CONDITION_PART8_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART8_ENDPOS + 1
    ),
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART8_ENDPOS + 1,
      v_LKP_PET_CONDITION_PART9_ENDPOS - (v_LKP_PET_CONDITION_PART8_ENDPOS + 1)
    )
  ) AS v_LKP_PET_CONDITION_PART9,
  IFF(
    v_LKP_PET_CONDITION_PART9_ENDPOS != 0,
    substr(
      src_LKP_PET_CONDITION,
      v_LKP_PET_CONDITION_PART9_ENDPOS + 1
    ),
    NULL
  ) AS v_LKP_PET_CONDITION_PART10,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART1),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART1),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART1)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART1_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART2),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART2),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART2)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART2_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART3),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART3),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART3)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART3_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART4),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART4),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART4)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART4_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART5),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART5),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART5)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART5_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART6),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART6),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART6)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART6_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART7),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART7),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART7)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART7_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART8),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART8),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART8)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART8_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART9),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART9),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART9)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART9_LKP,
  IFF(
    ISNULL(v_LKP_PET_CONDITION_PART10),
    NULL,
    IFF(
      IS_NUMBER(v_LKP_PET_CONDITION_PART10),
      LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART10)),
      NULL
    )
  ) AS v_LKP_PET_CONDITION_PART10_LKP,
  rtrim(
    (
      IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) = 0,
            src_PET_MEDICAL_CONDITION,
            substr(
              src_PET_MEDICAL_CONDITION,
              1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) -1
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART1),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART1),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART1)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) = 0,
            src_PET_MEDICAL_CONDITION,
            substr(
              src_PET_MEDICAL_CONDITION,
              1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) -1
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART1),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART1),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART1)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
                  and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
                  ),
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
                    and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
                    ),
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
                    )
                  )
                ),
                LKP_PET_CONDITION(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
                      and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
                      substr(
                        src_PET_MEDICAL_CONDITION,
                        instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
                      ),
                      substr(
                        src_PET_MEDICAL_CONDITION,
                        instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
                        instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
                and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
                substr(
                  src_PET_MEDICAL_CONDITION,
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
                ),
                substr(
                  src_PET_MEDICAL_CONDITION,
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
                  and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
                  ),
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
                  )
                )
              ),
              LKP_PET_CONDITION(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) = 0
                    and instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) != 0,
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1
                    ),
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 1) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART3),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART3),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART3)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 2) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART3),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART3),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART3)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART4),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART4),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART4)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 3) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART4),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART4),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART4)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART5),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART5),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART5)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 4) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART5),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART5),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART5)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
                  and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
                    and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
                    )
                  )
                ),
                LKP_PET_CONDITION(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
                      and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
                      substr(
                        src_PET_MEDICAL_CONDITION,
                        instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
                      ),
                      substr(
                        src_PET_MEDICAL_CONDITION,
                        instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
                        instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
                and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
                substr(
                  src_PET_MEDICAL_CONDITION,
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
                ),
                substr(
                  src_PET_MEDICAL_CONDITION,
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
                  and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_MEDICAL_CONDITION,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
                  )
                )
              ),
              LKP_PET_CONDITION(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) = 0
                    and instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) != 0,
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_MEDICAL_CONDITION,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1,
                      instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 5) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART7),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART7),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART7)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 6) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART7),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART7),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART7)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART8),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART8),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART8)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 7) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART8),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART8),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART8)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART9),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART9),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART9)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) = 0
            and instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) + 1
            ),
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) + 1,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) - (instr(src_PET_MEDICAL_CONDITION, '|', 1, 8) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART9),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART9),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART9)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) + 1
            ),
            NULL
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_LKP_PET_CONDITION_PART10),
              NULL,
              IFF(
                IS_NUMBER(v_LKP_PET_CONDITION_PART10),
                LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART10)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) != 0,
            substr(
              src_PET_MEDICAL_CONDITION,
              instr(src_PET_MEDICAL_CONDITION, '|', 1, 9) + 1
            ),
            NULL
          ) || '|',
          IFF(
            ISNULL(v_LKP_PET_CONDITION_PART10),
            NULL,
            IFF(
              IS_NUMBER(v_LKP_PET_CONDITION_PART10),
              LKP_PET_CONDITION(TO_INTEGER(v_LKP_PET_CONDITION_PART10)),
              NULL
            )
          ) || '|'
        )
      )
    ),
    ' |'
  ) AS LKP_PET_CONDITION_DESC,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  EXP_UPDATE_FLAG_30"""

df_33 = spark.sql(query_33)

df_33.createOrReplaceTempView("exp_retrieve_LKP_PET_CONDITION_33")

# COMMAND ----------
# DBTITLE 1, exp_retrieve_PET_ALLERGIES1_34


query_34 = f"""SELECT
  instr(src_PET_ALLERGIES, '|', 1, 1) AS v_PET_ALLERGIES_PART1_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 2) AS v_PET_ALLERGIES_PART2_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 3) AS v_PET_ALLERGIES_PART3_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 4) AS v_PET_ALLERGIES_PART4_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 5) AS v_PET_ALLERGIES_PART5_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 6) AS v_PET_ALLERGIES_PART6_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 7) AS v_PET_ALLERGIES_PART7_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 8) AS v_PET_ALLERGIES_PART8_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 9) AS v_PET_ALLERGIES_PART9_ENDPOS,
  IFF(
    v_PET_ALLERGIES_PART1_ENDPOS = 0,
    src_PET_ALLERGIES,
    substr(
      src_PET_ALLERGIES,
      1,
      v_PET_ALLERGIES_PART1_ENDPOS -1
    )
  ) AS v_PET_ALLERGIES_PART1,
  IFF(
    v_PET_ALLERGIES_PART2_ENDPOS = 0
    and v_PET_ALLERGIES_PART1_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART1_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART1_ENDPOS + 1,
      v_PET_ALLERGIES_PART2_ENDPOS - (v_PET_ALLERGIES_PART1_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART2,
  IFF(
    v_PET_ALLERGIES_PART3_ENDPOS = 0
    and v_PET_ALLERGIES_PART2_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART2_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART2_ENDPOS + 1,
      v_PET_ALLERGIES_PART3_ENDPOS - (v_PET_ALLERGIES_PART2_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART3,
  IFF(
    v_PET_ALLERGIES_PART4_ENDPOS = 0
    and v_PET_ALLERGIES_PART3_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART3_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART3_ENDPOS + 1,
      v_PET_ALLERGIES_PART4_ENDPOS - (v_PET_ALLERGIES_PART3_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART4,
  IFF(
    v_PET_ALLERGIES_PART5_ENDPOS = 0
    and v_PET_ALLERGIES_PART4_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART4_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART4_ENDPOS + 1,
      v_PET_ALLERGIES_PART5_ENDPOS - (v_PET_ALLERGIES_PART4_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART5,
  IFF(
    v_PET_ALLERGIES_PART6_ENDPOS = 0
    and v_PET_ALLERGIES_PART5_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART5_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART5_ENDPOS + 1,
      v_PET_ALLERGIES_PART6_ENDPOS - (v_PET_ALLERGIES_PART5_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART6,
  IFF(
    v_PET_ALLERGIES_PART7_ENDPOS = 0
    and v_PET_ALLERGIES_PART6_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART6_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART6_ENDPOS + 1,
      v_PET_ALLERGIES_PART7_ENDPOS - (v_PET_ALLERGIES_PART6_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART7,
  IFF(
    v_PET_ALLERGIES_PART8_ENDPOS = 0
    and v_PET_ALLERGIES_PART7_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART7_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART7_ENDPOS + 1,
      v_PET_ALLERGIES_PART8_ENDPOS - (v_PET_ALLERGIES_PART7_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART8,
  IFF(
    v_PET_ALLERGIES_PART9_ENDPOS = 0
    and v_PET_ALLERGIES_PART8_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART8_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART8_ENDPOS + 1,
      v_PET_ALLERGIES_PART9_ENDPOS - (v_PET_ALLERGIES_PART8_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART9,
  IFF(
    v_PET_ALLERGIES_PART9_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART9_ENDPOS + 1),
    NULL
  ) AS v_PET_ALLERGIES_PART10,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART1),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART1),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART1)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART1_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART2),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART2),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART2)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART2_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART3),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART3),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART3)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART3_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART4),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART4),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART4)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART4_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART5),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART5),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART5)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART5_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART6),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART6),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART6)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART6_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART7),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART7),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART7)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART7_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART8),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART8),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART8)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART8_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART9),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART9),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART9)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART9_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART10),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART10),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART10)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART10_LKP,
  rtrim(
    (
      IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
            src_PET_MEDICATION_ALLERGIES,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
                  src_PET_MEDICATION_ALLERGIES,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
                    src_PET_MEDICATION_ALLERGIES,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
                      src_PET_MEDICATION_ALLERGIES,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
            src_PET_MEDICATION_ALLERGIES,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
                src_PET_MEDICATION_ALLERGIES,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
                  src_PET_MEDICATION_ALLERGIES,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) = 0,
                    src_PET_MEDICATION_ALLERGIES,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) -1
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 1) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 2) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 3) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 4) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 5) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_ALLERGIES_PART7),
              NULL,
              IFF(
                IS_NUMBER(v_PET_ALLERGIES_PART7),
                LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART7)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 6) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_PET_ALLERGIES_PART7),
            NULL,
            IFF(
              IS_NUMBER(v_PET_ALLERGIES_PART7),
              LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART7)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 7) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_ALLERGIES_PART9_ENDPOS = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
              v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_ALLERGIES_PART9_ENDPOS = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
                    v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_ALLERGIES_PART9_ENDPOS = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
                      v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      v_PET_ALLERGIES_PART9_ENDPOS = 0
                      and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
                      ),
                      substr(
                        src_PET_MEDICATION_ALLERGIES,
                        instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
                        v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_ALLERGIES_PART9_ENDPOS = 0
            and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
            ),
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
              v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_ALLERGIES_PART9_ENDPOS = 0
                and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
                ),
                substr(
                  src_PET_MEDICATION_ALLERGIES,
                  instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
                  v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_ALLERGIES_PART9_ENDPOS = 0
                  and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
                  ),
                  substr(
                    src_PET_MEDICATION_ALLERGIES,
                    instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
                    v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    v_PET_ALLERGIES_PART9_ENDPOS = 0
                    and instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) != 0,
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1
                    ),
                    substr(
                      src_PET_MEDICATION_ALLERGIES,
                      instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1,
                      v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 8) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 9) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 9) + 1
            ),
            NULL
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_ALLERGIES_PART10),
              NULL,
              IFF(
                IS_NUMBER(v_PET_ALLERGIES_PART10),
                LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART10)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 9) != 0,
            substr(
              src_PET_MEDICATION_ALLERGIES,
              instr(src_PET_MEDICATION_ALLERGIES, '|', 1, 9) + 1
            ),
            NULL
          ) || '|',
          IFF(
            ISNULL(v_PET_ALLERGIES_PART10),
            NULL,
            IFF(
              IS_NUMBER(v_PET_ALLERGIES_PART10),
              LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART10)),
              NULL
            )
          ) || '|'
        )
      )
    ),
    ' |'
  ) AS PET_ALLERGIES_DESC,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  EXP_UPDATE_FLAG_30"""

df_34 = spark.sql(query_34)

df_34.createOrReplaceTempView("exp_retrieve_PET_ALLERGIES1_34")

# COMMAND ----------
# DBTITLE 1, exp_retrieve_PET_ALLERGIES_35


query_35 = f"""SELECT
  instr(src_PET_ALLERGIES, '|', 1, 1) AS v_PET_ALLERGIES_PART1_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 2) AS v_PET_ALLERGIES_PART2_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 3) AS v_PET_ALLERGIES_PART3_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 4) AS v_PET_ALLERGIES_PART4_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 5) AS v_PET_ALLERGIES_PART5_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 6) AS v_PET_ALLERGIES_PART6_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 7) AS v_PET_ALLERGIES_PART7_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 8) AS v_PET_ALLERGIES_PART8_ENDPOS,
  instr(src_PET_ALLERGIES, '|', 1, 9) AS v_PET_ALLERGIES_PART9_ENDPOS,
  IFF(
    v_PET_ALLERGIES_PART1_ENDPOS = 0,
    src_PET_ALLERGIES,
    substr(
      src_PET_ALLERGIES,
      1,
      v_PET_ALLERGIES_PART1_ENDPOS -1
    )
  ) AS v_PET_ALLERGIES_PART1,
  IFF(
    v_PET_ALLERGIES_PART2_ENDPOS = 0
    and v_PET_ALLERGIES_PART1_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART1_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART1_ENDPOS + 1,
      v_PET_ALLERGIES_PART2_ENDPOS - (v_PET_ALLERGIES_PART1_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART2,
  IFF(
    v_PET_ALLERGIES_PART3_ENDPOS = 0
    and v_PET_ALLERGIES_PART2_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART2_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART2_ENDPOS + 1,
      v_PET_ALLERGIES_PART3_ENDPOS - (v_PET_ALLERGIES_PART2_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART3,
  IFF(
    v_PET_ALLERGIES_PART4_ENDPOS = 0
    and v_PET_ALLERGIES_PART3_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART3_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART3_ENDPOS + 1,
      v_PET_ALLERGIES_PART4_ENDPOS - (v_PET_ALLERGIES_PART3_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART4,
  IFF(
    v_PET_ALLERGIES_PART5_ENDPOS = 0
    and v_PET_ALLERGIES_PART4_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART4_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART4_ENDPOS + 1,
      v_PET_ALLERGIES_PART5_ENDPOS - (v_PET_ALLERGIES_PART4_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART5,
  IFF(
    v_PET_ALLERGIES_PART6_ENDPOS = 0
    and v_PET_ALLERGIES_PART5_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART5_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART5_ENDPOS + 1,
      v_PET_ALLERGIES_PART6_ENDPOS - (v_PET_ALLERGIES_PART5_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART6,
  IFF(
    v_PET_ALLERGIES_PART7_ENDPOS = 0
    and v_PET_ALLERGIES_PART6_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART6_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART6_ENDPOS + 1,
      v_PET_ALLERGIES_PART7_ENDPOS - (v_PET_ALLERGIES_PART6_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART7,
  IFF(
    v_PET_ALLERGIES_PART8_ENDPOS = 0
    and v_PET_ALLERGIES_PART7_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART7_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART7_ENDPOS + 1,
      v_PET_ALLERGIES_PART8_ENDPOS - (v_PET_ALLERGIES_PART7_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART8,
  IFF(
    v_PET_ALLERGIES_PART9_ENDPOS = 0
    and v_PET_ALLERGIES_PART8_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART8_ENDPOS + 1),
    substr(
      src_PET_ALLERGIES,
      v_PET_ALLERGIES_PART8_ENDPOS + 1,
      v_PET_ALLERGIES_PART9_ENDPOS - (v_PET_ALLERGIES_PART8_ENDPOS + 1)
    )
  ) AS v_PET_ALLERGIES_PART9,
  IFF(
    v_PET_ALLERGIES_PART9_ENDPOS != 0,
    substr(src_PET_ALLERGIES, v_PET_ALLERGIES_PART9_ENDPOS + 1),
    NULL
  ) AS v_PET_ALLERGIES_PART10,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART1),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART1),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART1)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART1_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART2),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART2),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART2)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART2_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART3),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART3),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART3)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART3_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART4),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART4),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART4)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART4_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART5),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART5),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART5)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART5_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART6),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART6),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART6)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART6_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART7),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART7),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART7)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART7_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART8),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART8),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART8)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART8_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART9),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART9),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART9)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART9_LKP,
  IFF(
    ISNULL(v_PET_ALLERGIES_PART10),
    NULL,
    IFF(
      IS_NUMBER(v_PET_ALLERGIES_PART10),
      LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART10)),
      NULL
    )
  ) AS v_PET_ALLERGIES_PART10_LKP,
  rtrim(
    (
      IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
            src_PET_ALLERGIES,
            substr(
              src_PET_ALLERGIES,
              1,
              instr(src_PET_ALLERGIES, '|', 1, 1) -1
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
                  src_PET_ALLERGIES,
                  substr(
                    src_PET_ALLERGIES,
                    1,
                    instr(src_PET_ALLERGIES, '|', 1, 1) -1
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
                    src_PET_ALLERGIES,
                    substr(
                      src_PET_ALLERGIES,
                      1,
                      instr(src_PET_ALLERGIES, '|', 1, 1) -1
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
                      src_PET_ALLERGIES,
                      substr(
                        src_PET_ALLERGIES,
                        1,
                        instr(src_PET_ALLERGIES, '|', 1, 1) -1
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
            src_PET_ALLERGIES,
            substr(
              src_PET_ALLERGIES,
              1,
              instr(src_PET_ALLERGIES, '|', 1, 1) -1
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
                src_PET_ALLERGIES,
                substr(
                  src_PET_ALLERGIES,
                  1,
                  instr(src_PET_ALLERGIES, '|', 1, 1) -1
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
                  src_PET_ALLERGIES,
                  substr(
                    src_PET_ALLERGIES,
                    1,
                    instr(src_PET_ALLERGIES, '|', 1, 1) -1
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 1) = 0,
                    src_PET_ALLERGIES,
                    substr(
                      src_PET_ALLERGIES,
                      1,
                      instr(src_PET_ALLERGIES, '|', 1, 1) -1
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 2) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 1) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 2) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 1) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 2) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 1) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 2) = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 1) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
                        instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 2) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 1) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 2) = 0
                and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 1) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
                  instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 2) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 1) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 2) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 1) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 1) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 1) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 2) - (instr(src_PET_ALLERGIES, '|', 1, 1) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 3) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 2) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 3) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 2) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 3) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 2) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 3) = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 2) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
                        instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 3) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 2) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 3) = 0
                and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 2) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
                  instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 3) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 2) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 3) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 2) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 2) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 2) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 3) - (instr(src_PET_ALLERGIES, '|', 1, 2) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 4) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 3) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 4) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 3) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 4) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 3) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 4) = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 3) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
                        instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 4) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 3) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 4) = 0
                and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 3) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
                  instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 4) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 3) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 4) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 3) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 3) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 3) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 4) - (instr(src_PET_ALLERGIES, '|', 1, 3) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 5) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 4) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 5) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 4) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 5) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 4) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 5) = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 4) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
                        instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 5) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 4) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 5) = 0
                and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 4) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
                  instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 5) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 4) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 5) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 4) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 4) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 4) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 5) - (instr(src_PET_ALLERGIES, '|', 1, 4) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 6) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 5) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 6) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 6) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 6) = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 5) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
                        instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 6) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 5) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 6) = 0
                and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 5) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
                  instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 6) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 5) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 6) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 5) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 5) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 5) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 6) - (instr(src_PET_ALLERGIES, '|', 1, 5) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 7) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 6) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 6) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 6) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 7) - (instr(src_PET_ALLERGIES, '|', 1, 6) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_ALLERGIES_PART7),
              NULL,
              IFF(
                IS_NUMBER(v_PET_ALLERGIES_PART7),
                LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART7)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 7) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 6) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 6) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 6) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 7) - (instr(src_PET_ALLERGIES, '|', 1, 6) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(v_PET_ALLERGIES_PART7),
            NULL,
            IFF(
              IS_NUMBER(v_PET_ALLERGIES_PART7),
              LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART7)),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 8) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 7) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 8) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 7) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 8) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 7) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      instr(src_PET_ALLERGIES, '|', 1, 8) = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 7) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
                        instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 8) = 0
            and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 7) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
              instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                instr(src_PET_ALLERGIES, '|', 1, 8) = 0
                and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 7) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
                  instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  instr(src_PET_ALLERGIES, '|', 1, 8) = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 7) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
                    instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    instr(src_PET_ALLERGIES, '|', 1, 8) = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 7) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 7) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 7) + 1,
                      instr(src_PET_ALLERGIES, '|', 1, 8) - (instr(src_PET_ALLERGIES, '|', 1, 7) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            v_PET_ALLERGIES_PART9_ENDPOS = 0
            and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 8) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
              v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
            )
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(
                IFF(
                  v_PET_ALLERGIES_PART9_ENDPOS = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 8) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
                    v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
                  )
                )
              ),
              NULL,
              IFF(
                IS_NUMBER(
                  IFF(
                    v_PET_ALLERGIES_PART9_ENDPOS = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 8) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
                      v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
                    )
                  )
                ),
                LKP_PET_ALLERGIES(
                  TO_INTEGER(
                    IFF(
                      v_PET_ALLERGIES_PART9_ENDPOS = 0
                      and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 8) + 1
                      ),
                      substr(
                        src_PET_ALLERGIES,
                        instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
                        v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
                      )
                    )
                  )
                ),
                NULL
              )
            )
          ),
          IFF(
            v_PET_ALLERGIES_PART9_ENDPOS = 0
            and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 8) + 1
            ),
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
              v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
            )
          ) || '|',
          IFF(
            ISNULL(
              IFF(
                v_PET_ALLERGIES_PART9_ENDPOS = 0
                and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 8) + 1
                ),
                substr(
                  src_PET_ALLERGIES,
                  instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
                  v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
                )
              )
            ),
            NULL,
            IFF(
              IS_NUMBER(
                IFF(
                  v_PET_ALLERGIES_PART9_ENDPOS = 0
                  and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 8) + 1
                  ),
                  substr(
                    src_PET_ALLERGIES,
                    instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
                    v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
                  )
                )
              ),
              LKP_PET_ALLERGIES(
                TO_INTEGER(
                  IFF(
                    v_PET_ALLERGIES_PART9_ENDPOS = 0
                    and instr(src_PET_ALLERGIES, '|', 1, 8) != 0,
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 8) + 1
                    ),
                    substr(
                      src_PET_ALLERGIES,
                      instr(src_PET_ALLERGIES, '|', 1, 8) + 1,
                      v_PET_ALLERGIES_PART9_ENDPOS - (instr(src_PET_ALLERGIES, '|', 1, 8) + 1)
                    )
                  )
                )
              ),
              NULL
            )
          ) || '|'
        )
      ) || IFF(
        ISNULL(
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 9) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 9) + 1
            ),
            NULL
          )
        ),
        NULL,
        IFF(
          ISNULL(
            IFF(
              ISNULL(v_PET_ALLERGIES_PART10),
              NULL,
              IFF(
                IS_NUMBER(v_PET_ALLERGIES_PART10),
                LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART10)),
                NULL
              )
            )
          ),
          IFF(
            instr(src_PET_ALLERGIES, '|', 1, 9) != 0,
            substr(
              src_PET_ALLERGIES,
              instr(src_PET_ALLERGIES, '|', 1, 9) + 1
            ),
            NULL
          ) || '|',
          IFF(
            ISNULL(v_PET_ALLERGIES_PART10),
            NULL,
            IFF(
              IS_NUMBER(v_PET_ALLERGIES_PART10),
              LKP_PET_ALLERGIES(TO_INTEGER(v_PET_ALLERGIES_PART10)),
              NULL
            )
          ) || '|'
        )
      )
    ),
    ' |'
  ) AS PET_ALLERGIES_DESC,
  Monotonically_Increasing_Id AS Monotonically_Increasing_Id
FROM
  EXP_UPDATE_FLAG_30"""

df_35 = spark.sql(query_35)

df_35.createOrReplaceTempView("exp_retrieve_PET_ALLERGIES_35")

# COMMAND ----------
# DBTITLE 1, UPD_INSERT_UPDATE_36


query_36 = f"""SELECT
  EUF3.src_OMS_ORDER_ID AS src_OMS_ORDER_ID,
  EUF3.src_OMS_ORDER_LINE_ID AS src_OMS_ORDER_LN_ID,
  EUF3.src_PRODUCT_ID AS src_PRODUCT_ID,
  EUF3.src_RX_SKU AS RX_SKU,
  EUF3.src_RX_STATUS AS RX_STATUS,
  EUF3.o_RX_STATUS_UPDATE_TSTMP AS RX_STATUS_UPDATE_TSTMP,
  EUF3.src_PET_NAME AS PET_NAME,
  EUF3.src_OMS_PET_TYPE_ID AS OMS_PET_TYPE_ID,
  erPA3.OMS_PET_TYPE_DESC AS OMS_PET_TYPE_DESC,
  EUF3.src_OMS_PET_BREED_ID AS OMS_PET_BREED_ID,
  erPA3.OMS_PET_BREED_DESC AS OMS_PET_BREED_DESC,
  EUF3.src_PET_WEIGHT AS PET_WEIGHT,
  EUF3.src_PET_BIRTH_DT AS PET_BIRTH_DT,
  EUF3.src_PET_AGE AS PET_AGE,
  EUF3.src_OMS_PET_GENDER_ID AS OMS_PET_GENDER_ID,
  erPA3.OMS_PET_GENDER_DESC AS OMS_PET_GENDER_DESC,
  EUF3.src_PET_RX_NOTES AS PET_RX_NOTES,
  EUF3.src_VET_NAME AS VET_NAME,
  EUF3.src_CLINIC_NAME AS CLINIC_NAME,
  EUF3.src_CLINIC_ADDRESS_1 AS CLINIC_ADDR_1,
  EUF3.src_CLINIC_CITY AS CLINIC_CITY,
  EUF3.src_CLINIC_STATE_PROV_CD AS CLINIC_STATE_PROV_CD,
  EUF3.src_CLINIC_PHONE AS CLINIC_PHONE,
  EUF3.src_CLINIC_FAX AS CLINIC_FAX,
  EUF3.src_CLINIC_EMAIL AS CLINIC_EMAIL,
  EUF3.src_CLINIC_CLINIC_HIN AS CLINIC_CLINIC_HIN,
  EUF3.src_RX_CONTACT_VET_FLAG AS RX_CONTACT_VET_FLAG,
  EUF3.src_PET_OWNER_NAME AS PET_OWNER_NAME,
  EUF3.src_RX_TYPE AS RX_TYPE,
  erPM3.PET_MEDICATIONS_DESC AS PET_MEDICATIONS,
  erPA3.PET_ALLERGIES_DESC AS PET_ALLERGIES,
  erPA3.PET_ALLERGIES_DESC AS PET_MEDICATION_ALLERGIES,
  erLPC3.LKP_PET_CONDITION_DESC AS PET_MEDICAL_CONDITION,
  EUF3.o_UPDATE_TSTMP AS o_UPDATE_TSTMP,
  EUF3.o_LOAD_TSTMP AS o_LOAD_TSTMP,
  EUF3.o_UPDATE_FLAG AS o_UPDATE_FLAG,
  EUF3.Monotonically_Increasing_Id AS Monotonically_Increasing_Id,
  DECODE(
    EUF3.o_UPDATE_FLAG,
    1,
    'DD_INSERT',
    2,
    'DD_UPDATE',
    'DD_REJECT'
  ) AS UPDATE_STRATEGY_FLAG
FROM
  EXP_UPDATE_FLAG_30 EUF3
  INNER JOIN exp_retrieve_PET_ATTRIBUTES_31 erPA3 ON EUF3.Monotonically_Increasing_Id = erPA3.Monotonically_Increasing_Id
  INNER JOIN exp_retrieve_PET_ALLERGIES1_34 erPA3 ON erPA3.Monotonically_Increasing_Id = erPA3.Monotonically_Increasing_Id
  INNER JOIN exp_retrieve_PET_MEDICATIONS_32 erPM3 ON erPA3.Monotonically_Increasing_Id = erPM3.Monotonically_Increasing_Id
  INNER JOIN exp_retrieve_PET_ALLERGIES_35 erPA3 ON erPM3.Monotonically_Increasing_Id = erPA3.Monotonically_Increasing_Id
  INNER JOIN exp_retrieve_LKP_PET_CONDITION_33 erLPC3 ON erPA3.Monotonically_Increasing_Id = erLPC3.Monotonically_Increasing_Id"""

df_36 = spark.sql(query_36)

df_36.createOrReplaceTempView("UPD_INSERT_UPDATE_36")

# COMMAND ----------
# DBTITLE 1, OMS_ORDER_LN_PET_RX_ATTR


spark.sql("""MERGE INTO OMS_ORDER_LN_PET_RX_ATTR AS TARGET
USING
  UPD_INSERT_UPDATE_36 AS SOURCE ON TARGET.OMS_ORDER_LN_ID = SOURCE.src_OMS_ORDER_LN_ID
  AND TARGET.OMS_ORDER_ID = SOURCE.src_OMS_ORDER_ID
  WHEN MATCHED
  AND SOURCE.UPDATE_STRATEGY_FLAG = "DD_UPDATE" THEN
UPDATE
SET
  TARGET.OMS_ORDER_ID = SOURCE.src_OMS_ORDER_ID,
  TARGET.OMS_ORDER_LN_ID = SOURCE.src_OMS_ORDER_LN_ID,
  TARGET.PRODUCT_ID = SOURCE.src_PRODUCT_ID,
  TARGET.RX_SKU = SOURCE.RX_SKU,
  TARGET.RX_STATUS = SOURCE.RX_STATUS,
  TARGET.RX_STATUS_UPDATE_TSTMP = SOURCE.RX_STATUS_UPDATE_TSTMP,
  TARGET.PET_NAME = SOURCE.PET_NAME,
  TARGET.OMS_PET_TYPE_ID = SOURCE.OMS_PET_TYPE_ID,
  TARGET.OMS_PET_TYPE_DESC = SOURCE.OMS_PET_TYPE_DESC,
  TARGET.OMS_PET_BREED_ID = SOURCE.OMS_PET_BREED_ID,
  TARGET.OMS_PET_BREED_DESC = SOURCE.OMS_PET_BREED_DESC,
  TARGET.PET_WEIGHT = SOURCE.PET_WEIGHT,
  TARGET.PET_BIRTH_DT = SOURCE.PET_BIRTH_DT,
  TARGET.PET_AGE = SOURCE.PET_AGE,
  TARGET.OMS_PET_GENDER_ID = SOURCE.OMS_PET_GENDER_ID,
  TARGET.OMS_PET_GENDER_DESC = SOURCE.OMS_PET_GENDER_DESC,
  TARGET.PET_RX_NOTES = SOURCE.PET_RX_NOTES,
  TARGET.VET_NAME = SOURCE.VET_NAME,
  TARGET.CLINIC_NAME = SOURCE.CLINIC_NAME,
  TARGET.CLINIC_ADDR_1 = SOURCE.CLINIC_ADDR_1,
  TARGET.CLINIC_CITY = SOURCE.CLINIC_CITY,
  TARGET.CLINIC_STATE_PROV_CD = SOURCE.CLINIC_STATE_PROV_CD,
  TARGET.CLINIC_PHONE = SOURCE.CLINIC_PHONE,
  TARGET.CLINIC_FAX = SOURCE.CLINIC_FAX,
  TARGET.CLINIC_EMAIL = SOURCE.CLINIC_EMAIL,
  TARGET.CLINIC_CLINIC_HIN = SOURCE.CLINIC_CLINIC_HIN,
  TARGET.RX_CONTACT_VET_FLAG = SOURCE.RX_CONTACT_VET_FLAG,
  TARGET.PET_OWNER_NAME = SOURCE.PET_OWNER_NAME,
  TARGET.RX_TYPE = SOURCE.RX_TYPE,
  TARGET.PET_MEDICATIONS = SOURCE.PET_MEDICATIONS,
  TARGET.PET_ALLERGIES = SOURCE.PET_ALLERGIES,
  TARGET.PET_MEDICATION_ALLERGIES = SOURCE.PET_MEDICATION_ALLERGIES,
  TARGET.PET_MEDICAL_CONDITION = SOURCE.PET_MEDICAL_CONDITION,
  TARGET.UPDATE_TSTMP = SOURCE.o_UPDATE_TSTMP,
  TARGET.LOAD_TSTMP = SOURCE.o_LOAD_TSTMP
  WHEN MATCHED
  AND SOURCE.UPDATE_STRATEGY_FLAG = "DD_DELETE"
  AND TARGET.PRODUCT_ID = SOURCE.src_PRODUCT_ID
  AND TARGET.RX_SKU = SOURCE.RX_SKU
  AND TARGET.RX_STATUS = SOURCE.RX_STATUS
  AND TARGET.RX_STATUS_UPDATE_TSTMP = SOURCE.RX_STATUS_UPDATE_TSTMP
  AND TARGET.PET_NAME = SOURCE.PET_NAME
  AND TARGET.OMS_PET_TYPE_ID = SOURCE.OMS_PET_TYPE_ID
  AND TARGET.OMS_PET_TYPE_DESC = SOURCE.OMS_PET_TYPE_DESC
  AND TARGET.OMS_PET_BREED_ID = SOURCE.OMS_PET_BREED_ID
  AND TARGET.OMS_PET_BREED_DESC = SOURCE.OMS_PET_BREED_DESC
  AND TARGET.PET_WEIGHT = SOURCE.PET_WEIGHT
  AND TARGET.PET_BIRTH_DT = SOURCE.PET_BIRTH_DT
  AND TARGET.PET_AGE = SOURCE.PET_AGE
  AND TARGET.OMS_PET_GENDER_ID = SOURCE.OMS_PET_GENDER_ID
  AND TARGET.OMS_PET_GENDER_DESC = SOURCE.OMS_PET_GENDER_DESC
  AND TARGET.PET_RX_NOTES = SOURCE.PET_RX_NOTES
  AND TARGET.VET_NAME = SOURCE.VET_NAME
  AND TARGET.CLINIC_NAME = SOURCE.CLINIC_NAME
  AND TARGET.CLINIC_ADDR_1 = SOURCE.CLINIC_ADDR_1
  AND TARGET.CLINIC_CITY = SOURCE.CLINIC_CITY
  AND TARGET.CLINIC_STATE_PROV_CD = SOURCE.CLINIC_STATE_PROV_CD
  AND TARGET.CLINIC_PHONE = SOURCE.CLINIC_PHONE
  AND TARGET.CLINIC_FAX = SOURCE.CLINIC_FAX
  AND TARGET.CLINIC_EMAIL = SOURCE.CLINIC_EMAIL
  AND TARGET.CLINIC_CLINIC_HIN = SOURCE.CLINIC_CLINIC_HIN
  AND TARGET.RX_CONTACT_VET_FLAG = SOURCE.RX_CONTACT_VET_FLAG
  AND TARGET.PET_OWNER_NAME = SOURCE.PET_OWNER_NAME
  AND TARGET.RX_TYPE = SOURCE.RX_TYPE
  AND TARGET.PET_MEDICATIONS = SOURCE.PET_MEDICATIONS
  AND TARGET.PET_ALLERGIES = SOURCE.PET_ALLERGIES
  AND TARGET.PET_MEDICATION_ALLERGIES = SOURCE.PET_MEDICATION_ALLERGIES
  AND TARGET.PET_MEDICAL_CONDITION = SOURCE.PET_MEDICAL_CONDITION
  AND TARGET.UPDATE_TSTMP = SOURCE.o_UPDATE_TSTMP
  AND TARGET.LOAD_TSTMP = SOURCE.o_LOAD_TSTMP THEN DELETE
  WHEN NOT MATCHED
  AND SOURCE.UPDATE_STRATEGY_FLAG = "DD_INSERT" THEN
INSERT
  (
    TARGET.OMS_ORDER_ID,
    TARGET.OMS_ORDER_LN_ID,
    TARGET.PRODUCT_ID,
    TARGET.RX_SKU,
    TARGET.RX_STATUS,
    TARGET.RX_STATUS_UPDATE_TSTMP,
    TARGET.PET_NAME,
    TARGET.OMS_PET_TYPE_ID,
    TARGET.OMS_PET_TYPE_DESC,
    TARGET.OMS_PET_BREED_ID,
    TARGET.OMS_PET_BREED_DESC,
    TARGET.PET_WEIGHT,
    TARGET.PET_BIRTH_DT,
    TARGET.PET_AGE,
    TARGET.OMS_PET_GENDER_ID,
    TARGET.OMS_PET_GENDER_DESC,
    TARGET.PET_RX_NOTES,
    TARGET.VET_NAME,
    TARGET.CLINIC_NAME,
    TARGET.CLINIC_ADDR_1,
    TARGET.CLINIC_CITY,
    TARGET.CLINIC_STATE_PROV_CD,
    TARGET.CLINIC_PHONE,
    TARGET.CLINIC_FAX,
    TARGET.CLINIC_EMAIL,
    TARGET.CLINIC_CLINIC_HIN,
    TARGET.RX_CONTACT_VET_FLAG,
    TARGET.PET_OWNER_NAME,
    TARGET.RX_TYPE,
    TARGET.PET_MEDICATIONS,
    TARGET.PET_ALLERGIES,
    TARGET.PET_MEDICATION_ALLERGIES,
    TARGET.PET_MEDICAL_CONDITION,
    TARGET.UPDATE_TSTMP,
    TARGET.LOAD_TSTMP
  )
VALUES
  (
    SOURCE.src_OMS_ORDER_ID,
    SOURCE.src_OMS_ORDER_LN_ID,
    SOURCE.src_PRODUCT_ID,
    SOURCE.RX_SKU,
    SOURCE.RX_STATUS,
    SOURCE.RX_STATUS_UPDATE_TSTMP,
    SOURCE.PET_NAME,
    SOURCE.OMS_PET_TYPE_ID,
    SOURCE.OMS_PET_TYPE_DESC,
    SOURCE.OMS_PET_BREED_ID,
    SOURCE.OMS_PET_BREED_DESC,
    SOURCE.PET_WEIGHT,
    SOURCE.PET_BIRTH_DT,
    SOURCE.PET_AGE,
    SOURCE.OMS_PET_GENDER_ID,
    SOURCE.OMS_PET_GENDER_DESC,
    SOURCE.PET_RX_NOTES,
    SOURCE.VET_NAME,
    SOURCE.CLINIC_NAME,
    SOURCE.CLINIC_ADDR_1,
    SOURCE.CLINIC_CITY,
    SOURCE.CLINIC_STATE_PROV_CD,
    SOURCE.CLINIC_PHONE,
    SOURCE.CLINIC_FAX,
    SOURCE.CLINIC_EMAIL,
    SOURCE.CLINIC_CLINIC_HIN,
    SOURCE.RX_CONTACT_VET_FLAG,
    SOURCE.PET_OWNER_NAME,
    SOURCE.RX_TYPE,
    SOURCE.PET_MEDICATIONS,
    SOURCE.PET_ALLERGIES,
    SOURCE.PET_MEDICATION_ALLERGIES,
    SOURCE.PET_MEDICAL_CONDITION,
    SOURCE.o_UPDATE_TSTMP,
    SOURCE.o_LOAD_TSTMP
  )""")

# COMMAND ----------
#Post session variable updation
updateVariable(postVariableAssignment, variablesTableName, mainWorkflowId, parentName, "m_OMS_RX_Order_LN")

# COMMAND ----------
#Update Mapping Variables in database.
persistVariables(variablesTableName, "m_OMS_RX_Order_LN", mainWorkflowId, parentName)
